<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Customers</title>
    <link rel="stylesheet" href="global.css" />
    <link rel="stylesheet" href="product_list.css" />
    <style>
      .main-content { padding-top: 12px; }
      .page-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
      .filter-btn { width: 42px; height: 42px; background: #262626; border: 1px solid #404040; border-radius: 8px; color: #e7e7e7; cursor: pointer; }
      .add-customer-btn { margin-left: auto; }
      .name-cell { display: inline-flex; align-items: center; gap: 10px; }
      .avatar { width: 28px; height: 28px; border-radius: 50%; background: #fff; border: 1px solid #333; object-fit: cover; }
      thead th, tbody td { vertical-align: middle; }
      table { border-collapse: collapse; table-layout: fixed; width: 100%; }
      .status-badge { display: inline-flex; align-items: center; padding: 2px 10px; border-radius: 999px; font-size: 12px; border: 1px solid #2a2a2a; background: #1f2223; color: #bdbdbd; }
      .status-badge.active { background: #0f2a14; color: #9ff6b2; border-color: #214d2c; }
      /* Column widths specific to customers table */
      thead th:nth-child(1), tbody td:nth-child(1) { width: 90px; }
      thead th:nth-child(2), tbody td:nth-child(2) { width: 220px; }
      thead th:nth-child(3), tbody td:nth-child(3) { width: 260px; }
      thead th:nth-child(4), tbody td:nth-child(4) { width: 160px; }
      thead th:nth-child(5), tbody td:nth-child(5) { width: 160px; }
      thead th:nth-child(6), tbody td:nth-child(6) { width: 120px; text-align: center; }
      thead th:nth-child(7), tbody td:nth-child(7) { width: 120px; text-align: center; }
      /* Override product_list alignment that right-aligns the 4th column */
      .customers-table thead th:nth-child(4),
      .customers-table tbody td:nth-child(4) { text-align: left; }
      /* Overlay modal */
      .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(2px); display: none; align-items: center; justify-content: center; z-index: 1000; }
      .overlay.open { display: flex; }
      .modal { width: 740px; max-width: 95vw; max-height: 95vh; background: #262626; border: 1px solid #333; border-radius: 12px; overflow: hidden; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,.5); }
      .modal header { padding: 10px 14px; border-bottom: 1px solid #333; font-weight: 700; }
      .modal-frame { width: 100%; height: 560px; border: 0; display: block; background: #262626; }
      .modal .close { position: absolute; top: 8px; right: 10px; width: 32px; height: 32px; border-radius: 6px; border: 1px solid #3a3a3a; background: #1f2223; color: #e7e7e7; cursor: pointer; }
      .container.blurred { filter: blur(3px); }
      
      /* Archive button styling */
      #openArchiveBtn {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 56px;
        height: 56px;
        background: #dc2626;
        color: #ffffff;
        border: none;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        transition: all 0.3s ease;
        z-index: 100;
      }
      
      #openArchiveBtn:hover {
        background: #b91c1c;
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
      }
      
      /* Archive modal styling */
      .archive-tabs {
        display: flex;
        border-bottom: 1px solid #404040;
        margin-bottom: 20px;
      }
      
      .archive-tab {
        flex: 1;
        padding: 12px 16px;
        background: none;
        border: none;
        color: #a3a3a3;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
      }
      
      .archive-tab.active {
        color: #4ade80;
        border-bottom-color: #4ade80;
      }
      
      .archive-tab:hover {
        color: #f5f5f5;
      }
      
      .archive-content {
        display: none;
      }
      
      .archive-content.active {
        display: block;
      }
      
      .archive-item {
        background: #2a2a2a;
        border: 1px solid #404040;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
      }
      
      .archive-item:hover {
        border-color: #525252;
        background: #323232;
      }
      
      .restored-item {
        background: #0f2a14;
        border-color: #214d2c;
      }
      
      .archive-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .archive-item-name {
        font-weight: 600;
        color: #f5f5f5;
        font-size: 16px;
      }
      
      .archive-item-date {
        font-size: 12px;
        color: #a3a3a3;
      }
      
      .archive-item-email {
        margin-bottom: 8px;
        color: #a3a3a3;
        font-size: 14px;
      }
      
      .archive-item-actions {
        display: flex;
        gap: 8px;
      }
      
      .restore-btn {
        background: #059669;
        color: #ffffff;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.3s ease;
      }
      
      .restore-btn:hover {
        background: #047857;
      }
      
      .permanent-delete-btn {
        background: #dc2626;
        color: #ffffff;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.3s ease;
      }
      
      .permanent-delete-btn:hover {
        background: #b91c1c;
      }
      
      #emptyArchiveBtn {
        background: #dc2626;
        color: #ffffff;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        margin-top: 16px;
        transition: background 0.3s ease;
      }
      
      #emptyArchiveBtn:hover {
        background: #b91c1c;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <aside class="sidebar">
        <div class="sidebar-top">
          <div class="brand"><img src="gelo.png" alt="Gelo's Vape Shop logo" /></div>
          <nav class="nav">
            <ul class="nav-list">
              <li><a href="Pages/dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
              <li class="has-submenu">
                <a href="Pages/inventory.html"><span class="icon">üì¶</span><span class="label">Inventory</span></a>
                <ul class="submenu">
                  <li><a href="product_list.html">Product List</a></li>
                </ul>
              </li>
              <li><a href="Pages/pos.html"><span class="icon">üßæ</span><span class="label">POS</span></a></li>
              <li><a href="customers.html" class="active"><span class="icon">üë•</span><span class="label">Customer</span></a></li>
              <li><a href="suppliers.html"><span class="icon">üöö</span><span class="label">Suppliers</span></a></li>
              <li class="has-submenu">
                <a href="reports.html"><span class="icon">üìä</span><span class="label">Reports</span></a>
                <ul class="submenu">
                  <li><a href="reports.html#sales-reports">Sales Reports</a></li>
                  <li><a href="reports.html#inventory-reports">Inventory Reports</a></li>
                  <li><a href="reports.html#financial-reports">Financial Reports</a></li>
                  <li><a href="reports.html#supplier-reports">Supplier Reports</a></li>
                  <li><a href="reports.html#customer-reports">Customer Reports</a></li>
                  <li><a href="reports.html#operational-reports">Operational Reports</a></li>
                </ul>
              </li>
              <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
            </ul>
          </nav>
        </div>
        <a href="index.html" class="logout"><span class="icon">‚éã</span><span class="label">Logout</span></a>
      </aside>

      <main class="main-content">
        <div class="toolbar">
          <div class="search-bar">
            <input type="search" placeholder="Search customers..." aria-label="Search customers" />
            <button type="submit" aria-label="Search"><span class="icon search"></span></button>
          </div>
          <button class="filter-btn" title="Filter" aria-label="Filter">‚öôÔ∏è</button>
          <button class="add-product-btn add-customer-btn"><span class="icon add" aria-hidden="true"></span>Add Customer</button>
        </div>

        <section class="table-card">
          <table class="customers-table" id="customersTable">
            <thead>
              <tr>
                <th>Customer ID</th>
                <th style="text-align:left">Name</th>
                <th style="text-align:left">Email</th>
                <th style="text-align:left">Phone</th>
                <th style="text-align:left">Last Purchase</th>
                <th style="text-align:center">Status</th>
                <th style="text-align:center">Actions</th>
              </tr>
            </thead>
            <tbody id="customersBody"><tr><td colspan="7" style="color:#a3a3a3; padding:12px">Loading customers...</td></tr></tbody>
          </table>

          <div class="pagination">
            <button class="page-btn">Previous</button>
            <button class="page-btn active">1</button>
            <button class="page-btn">2</button>
            <button class="page-btn">3</button>
            <button class="page-btn">Next</button>
      </div>
        </section>
      </main>
    </div>
    <!-- Add Customer Overlay -->
    <div id="customerOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Add Customer">
      <div class="modal">
        <button class="close" type="button" aria-label="Close">√ó</button>
        <iframe class="modal-frame" src="add_customer.html" title="Add New Customer"></iframe>
      </div>
    </div>
    <!-- Edit Customer Overlay -->
    <div id="editCustomerOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Edit Customer">
      <div class="modal">
        <button class="close" type="button" aria-label="Close">√ó</button>
        <iframe class="modal-frame" src="edit_customer.html" title="Edit Customer"></iframe>
      </div>
    </div>

    <!-- Archive Modal -->
    <div class="overlay" id="archiveModal" role="dialog" aria-modal="true" aria-label="Archive">
      <div class="modal">
        <button class="close" type="button" aria-label="Close">√ó</button>
        <div style="padding: 20px;">
          <h3 style="margin: 0 0 20px 0; color: #f5f5f5;">Archive</h3>
          <div class="archive-tabs">
            <button class="archive-tab active" onclick="openArchiveTab('active')">Active Customers</button>
            <button class="archive-tab" onclick="openArchiveTab('deleted')">Deleted Customers</button>
          </div>
          <div class="archive-content active" id="activeArchiveContent">
            <div id="activeCustomersContent">
              <!-- Active customers will be populated dynamically -->
            </div>
          </div>
          <div class="archive-content" id="deletedArchiveContent">
            <!-- No deleted customers -->
            <p style="text-align: center; color: #a3a3a3; margin: 40px 0;">No deleted customers found.</p>
            <button id="emptyArchiveBtn" onclick="emptyArchive()" style="display: block; margin: 20px auto; padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">Empty Archive</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Archive Button -->
    <button id="openArchiveBtn" onclick="openArchiveModal()" title="Open Archive">üóëÔ∏è</button>

    <script>
      (function(){
        const container = document.querySelector('.container');

        // Add customer overlay
        const addOverlay = document.getElementById('customerOverlay');
        const addOpenBtn = document.querySelector('.add-customer-btn');
        const addCloseBtn = addOverlay.querySelector('.close');
        function openAdd(){ addOverlay.classList.add('open'); container.classList.add('blurred'); }
        function closeAdd(){ addOverlay.classList.remove('open'); container.classList.remove('blurred'); }
        if (addOpenBtn) addOpenBtn.addEventListener('click', openAdd);
        if (addCloseBtn) addCloseBtn.addEventListener('click', closeAdd);
        addOverlay.addEventListener('click', (e)=>{ if(e.target === addOverlay) closeAdd(); });

        // Edit customer overlay
        const editOverlay = document.getElementById('editCustomerOverlay');
        const editCloseBtn = editOverlay.querySelector('.close');
        function openEdit(){ editOverlay.classList.add('open'); container.classList.add('blurred'); }
        function closeEdit(){ editOverlay.classList.remove('open'); container.classList.remove('blurred'); }
        document.querySelectorAll('.actions .action-btn[title="Edit"]').forEach(btn=>{
          btn.addEventListener('click', openEdit);
        });
        if (editCloseBtn) editCloseBtn.addEventListener('click', closeEdit);
        editOverlay.addEventListener('click', (e)=>{ if(e.target === editOverlay) closeEdit(); });

        async function handleDelete(row){
          const id = Number(row.getAttribute('data-id'));
          const customerName = row.cells[1].querySelector('.name-cell').textContent.trim();
          const customerEmail = row.cells[2].textContent.trim();
          const customerPhone = row.cells[3].textContent.trim();
          if (!id) return;
          if (confirm(`Are you sure you want to delete ${customerName}?`)) {
            try {
              const res = await fetch(`api/customers.php?id=${id}`, { method:'DELETE' });
              const data = await res.json();
              if (!res.ok || !data.ok) throw new Error(data.error||'Delete failed');
              addToArchive(customerName, customerEmail, customerPhone);
              row.remove();
              updateArchiveDisplay();
              alert(`${customerName} has been moved to archive.`);
            } catch (e) {
              alert('Server error: ' + (e?.message || e));
            }
          }
        }

        // Esc key closes any open overlay
        document.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape'){ closeAdd(); closeEdit(); }
        });

        // PostMessage close hooks from iframes
        window.addEventListener('message', (e)=>{
          if (!e || !e.data) return;
          if (e.data.type === 'close-add-customer') closeAdd();
          if (e.data.type === 'close-edit-customer') closeEdit();
        });
        
        // Load customers from DB with last purchase data
        async function loadCustomers(){
          const tbody = document.getElementById('customersBody');
          if (tbody) tbody.innerHTML = '<tr><td colspan="7" style="color:#a3a3a3; padding:12px">Loading customers...</td></tr>';
          try {
            // Load customers
            const customersRes = await fetch('api/customers.php');
            const customersData = await customersRes.json();
            const customers = (customersRes.ok && customersData.ok) ? (customersData.data||[]) : [];
            
            // Load transactions to get last purchase dates
            const transactionsRes = await fetch('api/transactions.php');
            const transactionsData = await transactionsRes.json();
            const transactions = (transactionsRes.ok && transactionsData.ok) ? (transactionsData.data||[]) : [];
            
            if (!tbody) return;
            if (!customers.length) { tbody.innerHTML = '<tr><td colspan="7" style="color:#a3a3a3; padding:12px">No customers yet.</td></tr>'; return; }
            
            // Create a map of last purchase dates per customer
            const lastPurchaseMap = {};
            transactions.forEach(txn => {
              if (txn.customer_id && txn.date) {
                const txnDate = new Date(txn.date);
                if (!lastPurchaseMap[txn.customer_id] || txnDate > new Date(lastPurchaseMap[txn.customer_id])) {
                  lastPurchaseMap[txn.customer_id] = txn.date;
                }
              }
            });
            
            tbody.innerHTML = customers.map(c=>{
              const lastPurchase = lastPurchaseMap[c.id] ? 
                new Date(lastPurchaseMap[c.id]).toLocaleDateString() + ' ' + 
                new Date(lastPurchaseMap[c.id]).toLocaleTimeString() : '‚Äî';
              
              return `
              <tr data-id="${c.id}">
                <td>C${String(c.id).padStart(3,'0')}</td>
                <td><div class="name-cell"><img class="avatar" src="img/img.svg" alt="${c.name} avatar" />${c.name}</div></td>
                <td>${c.email||'‚Äî'}</td>
                <td>${c.phone||'‚Äî'}</td>
                <td>${lastPurchase}</td>
                <td style="text-align:center"><span class="status-badge active">Active</span></td>
                <td style="text-align:center"><div class="actions" style="justify-content:center"><button class="action-btn" title="Edit">‚úèÔ∏è</button><button class="action-btn" title="Delete">üóëÔ∏è</button></div></td>
              </tr>
            `;
            }).join('');
            
            // bind delete/edit
            document.querySelectorAll('#customersBody .action-btn[title="Delete"]').forEach(btn=>{
              btn.addEventListener('click', ()=> handleDelete(btn.closest('tr')));
            });
            document.querySelectorAll('#customersBody .action-btn[title="Edit"]').forEach(btn=>{
              btn.addEventListener('click', openEdit);
            });
          } catch (_) { if (tbody) tbody.innerHTML = '<tr><td colspan="7" style="color:#a3a3a3; padding:12px">Unable to load customers.</td></tr>'; }
        }
        loadCustomers();

        // Archive functionality
        let archivedCustomers = [];
      
      function addToArchive(name, email, phone) {
        const archivedCustomer = {
          id: Date.now(),
          name: name,
          email: email,
          phone: phone,
          deletedDate: new Date().toLocaleDateString()
        };
        archivedCustomers.push(archivedCustomer);
        updateArchiveDisplay();
      }
      
      function updateArchiveDisplay() {
        console.log('updateArchiveDisplay called, archivedCustomers:', archivedCustomers.length); // Debug log
        // Update deleted customers display
        const deletedContent = document.getElementById('deletedArchiveContent');
        if (archivedCustomers.length === 0) {
          deletedContent.innerHTML = '<p style="text-align: center; color: #a3a3a3; margin: 40px 0;">No deleted customers found.</p>';
        } else {
          let html = '';
          archivedCustomers.forEach(customer => {
            html += `
              <div class="archive-item">
                <div class="archive-item-header">
                  <div class="archive-item-name">${customer.name}</div>
                  <div class="archive-item-date">Deleted: ${customer.deletedDate}</div>
                </div>
                <div class="archive-item-email">${customer.email}</div>
                <div class="archive-item-actions">
                  <button class="restore-btn" onclick="restoreCustomer('${customer.id}')">Restore</button>
                  <button class="permanent-delete-btn" onclick="permanentDeleteCustomer('${customer.id}')">Delete Permanently</button>
                </div>
              </div>
            `;
          });
          deletedContent.innerHTML = html;
        }
        
        // Update active customers display
        updateActiveCustomersDisplay();
      }
      
      function updateActiveCustomersDisplay() {
        const activeContent = document.getElementById('activeCustomersContent');
        const activeRows = document.querySelectorAll('#customersTable tbody tr');
        
        console.log('Active rows found:', activeRows.length); // Debug log
        
        if (activeRows.length === 0) {
          activeContent.innerHTML = '<p style="text-align: center; color: #a3a3a3; margin: 40px 0;">No active customers found.</p>';
        } else {
          let html = '<table class="customers-table"><thead><tr><th style="text-align:left">Name</th><th style="text-align:left">Phone</th></tr></thead><tbody>';
          activeRows.forEach(row => {
            const name = row.cells[1].querySelector('.name-cell').textContent.trim();
            const phone = row.cells[3].textContent.trim();
            html += `
              <tr>
                <td><div class="name-cell"><img class="avatar" src="img/img.svg" alt="${name} avatar" />${name}</div></td>
                <td>${phone}</td>
              </tr>
            `;
          });
          html += '</tbody></table>';
          activeContent.innerHTML = html;
        }
      }
      
      function openArchiveModal() {
        const archiveModal = document.getElementById('archiveModal');
        archiveModal.classList.add('open');
        document.querySelector('.container').classList.add('blurred');
        // Update both displays when opening the modal
        updateArchiveDisplay();
        updateActiveCustomersDisplay();
      }

      function openArchiveTab(status) {
        document.querySelectorAll('.archive-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.archive-content').forEach(content => {
          content.classList.remove('active');
        });

        document.querySelector(`.archive-tab[onclick="openArchiveTab('${status}')"]`).classList.add('active');
        document.getElementById(`${status}ArchiveContent`).classList.add('active');
        
        // Update the content for the active tab
        if (status === 'active') {
          updateActiveCustomersDisplay();
        } else if (status === 'deleted') {
          // updateArchiveDisplay() already handles deleted content
        }
      }

      function restoreCustomer(customerId) {
        const customer = archivedCustomers.find(c => c.id == customerId);
        if (customer && confirm(`Are you sure you want to restore ${customer.name}?`)) {
          // Remove from archive
          archivedCustomers = archivedCustomers.filter(c => c.id != customerId);
          updateArchiveDisplay();
          
          // Add back to main table (you would typically add back to database here)
          const tbody = document.querySelector('#customersTable tbody');
          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>C${Date.now()}</td>
            <td><div class="name-cell"><img class="avatar" src="img/img.svg" alt="${customer.name} avatar" />${customer.name}</div></td>
            <td>${customer.email}</td>
            <td>${customer.phone}</td>
            <td>‚Äî</td>
            <td style="text-align:center"><span class="status-badge active">Active</span></td>
            <td style="text-align:center"><div class="actions" style="justify-content:center"><button class="action-btn" title="Edit">‚úèÔ∏è</button><button class="action-btn" title="Delete">üóëÔ∏è</button></div></td>
          `;
          tbody.appendChild(newRow);
          
          // Re-attach event listeners to the new row
          attachEventListenersToRow(newRow);
          
          // Update the archive display to reflect the restored customer
          updateArchiveDisplay();
          
          alert(`${customer.name} has been restored successfully!`);
        }
      }

      function permanentDeleteCustomer(customerId) {
        const customer = archivedCustomers.find(c => c.id == customerId);
        if (customer && confirm(`Are you sure you want to permanently delete ${customer.name}? This action cannot be undone.`)) {
          // Remove from archive permanently
          archivedCustomers = archivedCustomers.filter(c => c.id != customerId);
          updateArchiveDisplay();
          alert(`${customer.name} has been permanently deleted!`);
        }
      }
      
      function attachEventListenersToRow(row) {
        // Re-attach edit button listener
        const editBtn = row.querySelector('.action-btn[title="Edit"]');
        if (editBtn) {
          editBtn.addEventListener('click', openEdit);
        }
        
        const deleteBtn = row.querySelector('.action-btn[title="Delete"]');
        if (deleteBtn) { deleteBtn.addEventListener('click', ()=> handleDelete(row)); }
      }

      function emptyArchive() {
        if (confirm(`Are you sure you want to empty the archive? This action cannot be undone.`)) {
          archivedCustomers = [];
          updateArchiveDisplay();
          alert('Archive has been emptied successfully!');
        }
      }



      // Expose functions globally for inline handlers and floating button
      window.openArchiveModal = openArchiveModal;
      window.openArchiveTab = openArchiveTab;
      window.restoreCustomer = restoreCustomer;
      window.permanentDeleteCustomer = permanentDeleteCustomer;
      window.emptyArchive = emptyArchive;

      })();

      // Initialize archive display after DOM is fully loaded
      setTimeout(() => {
        updateArchiveDisplay();
      }, 100);
      
      // Archive modal event listeners
      const archiveModal = document.getElementById('archiveModal');
      
      // Close archive modal when clicking outside
      archiveModal.addEventListener('click', (e) => {
        if (e.target === archiveModal) {
          archiveModal.classList.remove('open');
          document.querySelector('.container').classList.remove('blurred');
        }
      });

      // Close archive modal when clicking the X button
      const archiveCloseBtn = archiveModal.querySelector('.close');
      if (archiveCloseBtn) {
        archiveCloseBtn.addEventListener('click', () => {
          archiveModal.classList.remove('open');
          document.querySelector('.container').classList.remove('blurred');
        });
      }

      // Close archive modal with Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && archiveModal.classList.contains('open')) {
          archiveModal.classList.remove('open');
          document.querySelector('.container').classList.remove('blurred');
        }
      });

      // Update "Last Purchase" from POS transactions
      (function(){
        function getTxns(){ try { return JSON.parse(localStorage.getItem('transactions')||'[]'); } catch { return []; } }
        const txns = getTxns().sort((a,b)=>new Date(b.date)-new Date(a.date));
        if (txns.length){
          const last = new Date(txns[0].date).toLocaleString();
          // Put last purchase on the first row for demo purposes
          const row = document.querySelector('#customersTable tbody tr');
          if (row) row.cells[4].textContent = last;
        }
        window.addEventListener('storage', ()=>{
          const refreshed = getTxns().sort((a,b)=>new Date(b.date)-new Date(a.date));
          if (refreshed.length){
            const last = new Date(refreshed[0].date).toLocaleString();
            const row = document.querySelector('#customersTable tbody tr');
            if (row) row.cells[4].textContent = last;
          }
        });
      })();

      // Publish customers list to localStorage for POS suggestions
      (function(){
        const T_BODY = document.querySelector('#customersTable tbody');
        function publishCustomers(){
          if (!T_BODY) return;
          const customers = Array.from(T_BODY.querySelectorAll('tr')).map(row=>{
            const name = row.cells[1]?.textContent?.trim() || '';
            const email = row.cells[2]?.textContent?.trim() || '';
            const phone = row.cells[3]?.textContent?.trim() || '';
            return { name, email, phone };
          }).filter(c=>c.name);
          try { localStorage.setItem('customers', JSON.stringify(customers)); } catch {}
        }
        // Initial publish
        publishCustomers();
        // Update on table changes
        if (T_BODY && 'MutationObserver' in window) {
          const obs = new MutationObserver(()=> publishCustomers());
          obs.observe(T_BODY, { childList: true, subtree: true, characterData: true });
        }
        // Also update when archive modal operations likely change rows
        window.addEventListener('storage', (e)=>{ if (e.key === 'transactions') publishCustomers(); });
      })();
    </script>
  </body>
</html>
