<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Reports Overview - Dashboard</title>
    <link rel="stylesheet" href="global.css" />
    <link rel="stylesheet" href="inventory.css" />
    <link rel="stylesheet" href="reports.css" />
    <link rel="stylesheet" href="style.css" />
    <!-- Offline-only: removed external CDN scripts; exports use built-in fallbacks -->
  </head>
  <body>
    <div class="container">
      <aside class="sidebar">
        <div class="sidebar-top">
          <div class="brand"><img src="gelo.png" alt="Gelo's Vape Shop logo" /></div>
          <nav class="nav">
            <ul class="nav-list">
              <li><a href="Pages/dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
              <li class="has-submenu">
                <a href="Pages/inventory.html"><span class="icon">üì¶</span><span class="label">Inventory</span></a>
                <ul class="submenu">
                  <li><a href="product_list.html">Product List</a></li>
                </ul>
              </li>
              <li><a href="Pages/pos.html"><span class="icon">üßæ</span><span class="label">POS</span></a></li>
              <li><a href="customers.html"><span class="icon">üë•</span><span class="label">Customer</span></a></li>
              <li><a href="suppliers.html"><span class="icon">üöö</span><span class="label">Suppliers</span></a></li>
              <li class="has-submenu">
                <a href="reports.html" class="active"><span class="icon">üìä</span><span class="label">Reports</span></a>
                <ul class="submenu">
                  <li><a href="#" class="report-link" data-section="sales-reports">Sales Reports</a></li>
                  <li><a href="#" class="report-link" data-section="inventory-reports">Inventory Reports</a></li>
                  <li><a href="#" class="report-link" data-section="financial-reports">Financial Reports</a></li>
                  <li><a href="#" class="report-link" data-section="supplier-reports">Supplier Reports</a></li>
                  <li><a href="#" class="report-link" data-section="customer-reports">Customer Reports</a></li>
                  <li><a href="#" class="report-link" data-section="operational-reports">Operational Reports</a></li>
                </ul>
              </li>
              <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
            </ul>
          </nav>
        </div>
        <a class="logout" href="index.html"><span class="icon">‚éã</span><span class="label">Logout</span></a>
      </aside>

      <main class="main-content">
        <header class="page-header">
          <div class="export-actions">
            <button class="btn export" data-export="csv">Export CSV</button>
            <button class="btn export" data-export="xlsx">Export Excel</button>
            <button class="btn export" data-export="pdf">Export PDF</button>
          </div>
        </header>

        <section class="reports-toolbar" aria-label="Filters">
          <div class="range">
            <label for="fromDate">From</label>
            <input id="fromDate" type="date" />
          </div>

          <div class="range">
            <label for="toDate">To</label>
            <input id="toDate" type="date" />
          </div>
          <div class="range">
            <label for="preset">Preset</label>
            <select id="preset">
              <option value="custom">Custom</option>
              <option value="today">Today</option>
              <option value="yesterday">Yesterday</option>
              <option value="this_week">This Week</option>
              <option value="this_month">This Month</option>
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
            </select>
          </div>
          <button class="btn apply" id="applyDateFilter">Apply</button>
        </section>

        <section class="report-section" id="sales-reports">
          <h2 class="section-title">Sales Reports</h2>
          <div class="section-toolbar">
            <div class="form-group">
              <label for="category_sales">Category</label>
              <select id="category_sales" aria-label="Select sales report category">
                <option value="all">All Categories</option>
                <option value="salesByProduct">Sales by Product</option>
                <option value="salesByCategory">Sales by Category</option>
                <option value="salesByEmployee">Sales by Employee</option>
                <option value="paymentBreakdown">Payment Method Breakdown</option>
              </select>
            </div>
          </div>
          <div class="cards">
            <div class="report-card"><div class="label">Total Revenue</div><div class="value" id="revTotal">‚Ç±0.00</div></div>
            <div class="report-card"><div class="label">Transactions</div><div class="value" id="txnCount">0</div></div>
            <div class="report-card"><div class="label">Avg. Order Value</div><div class="value" id="aov">‚Ç±0.00</div></div>
          </div>
          <div class="two-col">
            <div class="card-table">
              <header>Sales by Product</header>
              <table>
                <thead><tr><th>Product</th><th>Qty</th><th>Revenue</th></tr></thead>
                <tbody id="salesByProduct"><tr><td colspan="3">No data</td></tr></tbody>
              </table>
            </div>
            <div class="card-table">
              <header>Sales by Category</header>
              <table>
                <thead><tr><th>Category</th><th>Qty</th><th>Revenue</th></tr></thead>
                <tbody id="salesByCategory"><tr><td colspan="3">No data</td></tr></tbody>
              </table>
            </div>
          </div>
          <div class="two-col">
            <div class="card-table">
              <header>Sales by Employee / Cashier</header>
              <table>
                <thead><tr><th>Employee</th><th>Transactions</th><th>Revenue</th></tr></thead>
                <tbody id="salesByEmployee"><tr><td colspan="3">No data</td></tr></tbody>
              </table>
            </div>
            <div class="card-table">
              <header>Payment Method Breakdown</header>
              <table>
                <thead><tr><th>Method</th><th>Transactions</th><th>Revenue</th></tr></thead>
                <tbody id="paymentBreakdown"><tr><td colspan="3">No data</td></tr></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="report-section" id="inventory-reports">
          <h2 class="section-title">Inventory Reports</h2>
          <div class="section-toolbar">
            <div class="form-group">
              <label for="category_inventory">Category</label>
              <select id="category_inventory" aria-label="Select inventory report category">
                <option value="all">All Categories</option>
                <option value="stockLevels">Stock Levels</option>
                <option value="lowStock">Low Stock Alerts</option>
                <option value="inventoryValuation">Inventory Valuation</option>
                <option value="stockMovement">Stock Movement</option>
              </select>
            </div>
          </div>
          <div class="two-col">
            <div class="card-table">
              <header>Stock Levels</header>
              <table>
                <thead><tr><th>Product</th><th>Stock</th><th>Reorder Point</th></tr></thead>
                <tbody id="stockLevels"><tr><td colspan="3">No data</td></tr></tbody>
              </table>
            </div>
            <div class="card-table">
              <header>Low Stock Alerts</header>
              <table>
                <thead><tr><th>Product</th><th>Stock</th><th>Needed</th></tr></thead>
                <tbody id="lowStock"><tr><td colspan="3">No data</td></tr></tbody>
              </table>
            </div>
          </div>
          <div class="two-col">
            <div class="card-table">
              <header>Inventory Valuation</header>
              <table>
                <thead><tr><th>Category</th><th>Units</th><th>Cost Value</th></tr></thead>
                <tbody id="inventoryValuation"><tr><td colspan="3">No data</td></tr></tbody>
              </table>
            </div>
            <div class="card-table">
              <header>Stock Movement</header>
              <table>
                <thead><tr><th>Date</th><th>Product</th><th>Category</th><th>Type</th><th>Qty</th></tr></thead>
                <tbody id="stockMovement"><tr><td colspan="5">No data</td></tr></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="report-section" id="financial-reports">
          <h2 class="section-title">Financial Reports</h2>
          <div class="section-toolbar">
            <div class="form-group">
              <label for="category_financial">Category</label>
              <select id="category_financial" aria-label="Select financial report category">
                <option value="all">All Categories</option>
                <option value="pnl">Profit & Loss</option>
                <option value="taxReports">Tax Reports</option>
                <option value="refundsTable">Refunds & Returns</option>
              </select>
            </div>
          </div>
          <div class="cards">
            <div class="report-card"><div class="label">Profit & Loss</div><div class="value" id="pnl">‚Ç±0.00</div></div>
            <div class="report-card"><div class="label">Tax Collected</div><div class="value" id="taxCollected">‚Ç±0.00</div></div>
            <div class="report-card"><div class="label">Refunds & Discounts</div><div class="value" id="refundsDiscounts">‚Ç±0.00</div></div>
          </div>
          <div class="two-col">
            <div class="card-table">
              <header>Tax Reports</header>
              <table>
                <thead><tr><th>Tax Type</th><th>Base</th><th>Tax</th></tr></thead>
                <tbody id="taxReports"><tr><td colspan="3">No data</td></tr></tbody>
              </table>
            </div>
            <div class="card-table">
              <header>Returned / Refunded products</header>
              <table>
                <thead><tr><th>Type</th><th>Count</th><th>Amount</th></tr></thead>
                <tbody id="refundsTable"><tr><td colspan="3">No data</td></tr></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="report-section" id="supplier-reports">
          <h2 class="section-title">Supplier Reports</h2>
          <div class="section-toolbar">
            <div class="form-group">
              <label for="category_supplier">Category</label>
              <select id="category_supplier" aria-label="Select supplier report category">
                <option value="all">All Categories</option>
                <option value="supplierPerformance">Supplier Performance</option>
                <option value="supplierPayments">Supplier Payments</option>
                <option value="supplierProducts">Supplier Products</option>
              </select>
            </div>
          </div>
          <div class="cards">
            <div class="report-card"><div class="label">Total Suppliers</div><div class="value" id="totalSuppliers">0</div></div>
            <div class="report-card"><div class="label">Active Suppliers</div><div class="value" id="activeSuppliers">0</div></div>
            <div class="report-card"><div class="label">Total Spent</div><div class="value" id="totalSpentSuppliers">‚Ç±0</div></div>
          </div>
          <div class="two-col">
            <div class="card-table">
              <header>Spending by Supplier</header>
              <table>
                <thead><tr><th>Supplier</th><th>Categories</th><th>Orders</th><th>Total Spent</th></tr></thead>
                <tbody id="spendingBySupplier"><tr><td colspan="4">No data</td></tr></tbody>
              </table>
            </div>
            <div class="card-table">
              <header>Spending by Category</header>
              <table>
                <thead><tr><th>Category</th><th>Suppliers</th><th>Products</th><th>Total Spent</th></tr></thead>
                <tbody id="spendingByCategory"><tr><td colspan="4">No data</td></tr></tbody>
              </table>
            </div>
          </div>
          <div class="card-table">
            <header>Supplier Performance</header>
            <table>
              <thead><tr><th>Supplier</th><th>Categories</th><th>Avg Order Value</th><th>Order Frequency</th><th>Quality Rating</th></tr></thead>
              <tbody id="supplierPerformance"><tr><td colspan="5">No data</td></tr></tbody>
            </table>
          </div>
        </section>

        <section class="report-section" id="customer-reports">
          <h2 class="section-title">Customer Reports</h2>
          <div class="section-toolbar">
            <div class="form-group">
              <label for="category_customer">Category</label>
              <select id="category_customer" aria-label="Select customer report category">
                <option value="all">All Categories</option>
                <option value="purchaseHistory">Purchase History</option>
                <option value="loyalty">Loyalty Points</option>
                <option value="customerAnalytics">Customer Analytics</option>
              </select>
            </div>
          </div>
          <div class="two-col">
            <div class="card-table">
              <header>Purchase History</header>
              <table>
                <thead><tr><th>Date</th><th>Customer</th><th>Items</th><th>Total</th></tr></thead>
                <tbody id="purchaseHistory"><tr><td colspan="4">No data</td></tr></tbody>
              </table>
            </div>
            <div class="card-table">
              <header>Loyalty Points / Rewards</header>
              <table>
                <thead><tr><th>Customer</th><th>Points</th><th>Redeemed</th></tr></thead>
                <tbody id="loyalty"><tr><td colspan="3">No data</td></tr></tbody>
              </table>
            </div>
          </div>
          <div class="card-table">
            <header>Customer Demographics</header>
            <table>
              <thead><tr><th>Segment</th><th>Customers</th><th>Share</th></tr></thead>
              <tbody id="demographics"><tr><td colspan="3">No data</td></tr></tbody>
            </table>
          </div>
        </section>

        <section class="report-section" id="operational-reports">
          <h2 class="section-title">Operational Reports</h2>
          <div class="two-col">
            <div class="card-table">
              <header>Shift Reports / Z-Reports</header>
              <table>
                <thead><tr><th>Shift</th><th>Cash Count</th><th>Sales</th></tr></thead>
                <tbody id="shiftReports"><tr><td colspan="3">No data</td></tr></tbody>
              </table>
            </div>
            <div class="card-table">
              <header>Returned / Refunded products</header>
              <table>
                <thead><tr><th>Date</th><th>Txn ID</th><th>Employee</th><th>Reason</th></tr></thead>
                <tbody id="voids"><tr><td colspan="4">No data</td></tr></tbody>
              </table>
            </div>
          </div>
          <div class="card-table">
            <header>Staff Hours</header>
            <table>
              <thead><tr><th>Employee</th><th>Hours</th><th>Shifts</th></tr></thead>
              <tbody id="staffHours"><tr><td colspan="3">No data</td></tr></tbody>
            </table>
          </div>
        </section>

        <style>
          /* Submenu hover styles */
          .sidebar .has-submenu .submenu {
            display: none;
            padding-left: 20px;
            margin-top: 5px;
            max-height: 400px;
            overflow-y: auto;
          }
          
          .sidebar .has-submenu:hover .submenu {
            display: block;
          }
          
          .sidebar .submenu li {
            margin-bottom: 8px;
          }
          
          .sidebar .submenu a {
            color: #a3a3a3;
            font-size: 16px;
            transition: color 0.2s;
          }
          
          .sidebar .submenu a:hover,
          .sidebar .submenu a.active {
            color: #ffffff;
          }
          
          /* Hide all report sections by default */
          .report-section {
            display: none;
          }
          
          /* Show active report section */
          .report-section.active {
            display: block;
          }
        </style>
        
        <script>
          (function(){
            const preset = document.getElementById('preset');
            const from = document.getElementById('fromDate');
            const to = document.getElementById('toDate');
            const apply = document.getElementById('applyDateFilter');

            preset.addEventListener('change', () => {
              const today = new Date();
              const yesterday = new Date(today);
              yesterday.setDate(yesterday.getDate() - 1);
              const weekStart = new Date(today);
              weekStart.setDate(weekStart.getDate() - today.getDay());
              const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

              const yyyy = (d) => d.getFullYear();
              const mm = (d) => String(d.getMonth() + 1).padStart(2, '0');
              const dd = (d) => String(d.getDate()).padStart(2, '0');
              const formatDate = (d) => `${yyyy(d)}-${mm(d)}-${dd(d)}`;

              switch (preset.value) {
                case 'today':
                  from.value = formatDate(today);
                  to.value = formatDate(today);
                  break;
                case 'yesterday':
                  from.value = formatDate(yesterday);
                  to.value = formatDate(yesterday);
                  break;
                case 'this_week':
                  from.value = formatDate(weekStart);
                  to.value = formatDate(today);
                  break;
                case 'this_month':
                  from.value = formatDate(monthStart);
                  to.value = formatDate(today);
                  break;
                case '7':
                  from.value = formatDate(new Date(today.getTime() - 6 * 24 * 60 * 60 * 1000));
                  to.value = formatDate(today);
                  break;
                case '30':
                  from.value = formatDate(new Date(today.getTime() - 29 * 24 * 60 * 60 * 1000));
                  to.value = formatDate(today);
                  break;
              }
            });

            apply.addEventListener('click', renderAll);
            
            // Section-specific category filtering functionality
            const categoryFilters = {
              'sales-reports': document.getElementById('category_sales'),
              'inventory-reports': document.getElementById('category_inventory'),
              'financial-reports': document.getElementById('category_financial'),
              'supplier-reports': document.getElementById('category_supplier'),
              'customer-reports': document.getElementById('category_customer')
            };
            
            // Load saved category selections for each section
            function loadCategorySelections() {
              Object.keys(categoryFilters).forEach(sectionId => {
                const filter = categoryFilters[sectionId];
                if (filter) {
                  const savedCategory = localStorage.getItem(`selectedCategory_${sectionId}`) || 'all';
                  filter.value = savedCategory;
                  applySectionCategoryFilter(sectionId, savedCategory);
                }
              });
            }
            
            // Save category selection for specific section
            function saveCategorySelection(sectionId, category) {
              localStorage.setItem(`selectedCategory_${sectionId}`, category);
            }
            
            // Apply category filter to specific section
            function applySectionCategoryFilter(sectionId, category) {
              const section = document.getElementById(sectionId);
              if (!section) return;
              
              let tables = {};
              
              // Define tables for each section
              switch(sectionId) {
                case 'sales-reports':
                  tables = {
                    'salesByProduct': section.querySelector('#salesByProduct')?.closest('.card-table'),
                    'salesByCategory': section.querySelector('#salesByCategory')?.closest('.card-table'),
                    'salesByEmployee': section.querySelector('#salesByEmployee')?.closest('.card-table'),
                    'paymentBreakdown': section.querySelector('#paymentBreakdown')?.closest('.card-table')
                  };
                  break;
                case 'inventory-reports':
                  tables = {
                    'stockLevels': section.querySelector('#stockLevels')?.closest('.card-table'),
                    'lowStock': section.querySelector('#lowStock')?.closest('.card-table'),
                    'inventoryValuation': section.querySelector('#inventoryValuation')?.closest('.card-table'),
                    'stockMovement': section.querySelector('#stockMovement')?.closest('.card-table')
                  };
                  break;
                case 'financial-reports':
                  tables = {
                    'pnl': section.querySelector('.cards'),
                    'taxReports': section.querySelector('#taxReports')?.closest('.card-table'),
                    'refundsTable': section.querySelector('#refundsTable')?.closest('.card-table')
                  };
                  break;
                case 'supplier-reports':
                  tables = {
                    'supplierPerformance': section.querySelector('#supplierPerformance')?.closest('.card-table'),
                    'supplierPayments': section.querySelector('#spendingByCategory')?.closest('.card-table'),
                    'supplierProducts': section.querySelector('#supplierProducts')?.closest('.card-table')
                  };
                  break;
                case 'customer-reports':
                  tables = {
                    'purchaseHistory': section.querySelector('#purchaseHistory')?.closest('.card-table'),
                    'loyalty': section.querySelector('#loyalty')?.closest('.card-table'),
                    'customerAnalytics': section.querySelector('#customerAnalytics')?.closest('.card-table')
                  };
                  break;
              }
              
              if (category === 'all') {
                // Show all tables in this section
                Object.values(tables).forEach(table => {
                  if (table) table.style.display = '';
                });
              } else {
                // Hide all tables first
                Object.values(tables).forEach(table => {
                  if (table) table.style.display = 'none';
                });
                // Show only selected table
                if (tables[category]) {
                  tables[category].style.display = '';
                }
              }
            }
            
            // Add event listeners to all category filters
            Object.keys(categoryFilters).forEach(sectionId => {
              const filter = categoryFilters[sectionId];
              if (filter) {
                filter.addEventListener('change', (e) => {
                  const selectedCategory = e.target.value;
                  saveCategorySelection(sectionId, selectedCategory);
                  applySectionCategoryFilter(sectionId, selectedCategory);
                });
              }
            });
            
            // Initialize category filters
            loadCategorySelections();
            
            // Report section navigation
            const reportLinks = document.querySelectorAll('.report-link');
            const reportSections = document.querySelectorAll('.report-section');
            
            // Show only sales reports by default
            showReportSection('sales-reports');
            
            // Add click event to report links
            reportLinks.forEach(link => {
              link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = link.getAttribute('data-section');
                showReportSection(sectionId);
                
                // Update active state in submenu
                reportLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
              });
            });
            
            // Function to show only the selected report section
            function showReportSection(sectionId) {
              reportSections.forEach(section => {
                if (section.id === sectionId) {
                  section.classList.add('active');
                } else {
                  section.classList.remove('active');
                }
              });
            }
            
            // Export buttons functionality
            document.querySelectorAll('.export').forEach(btn => {
              btn.addEventListener('click', () => {
                const type = btn.getAttribute('data-export');
                const activeSection = document.querySelector('.report-section.active');
                const sectionTitle = activeSection ? activeSection.querySelector('.section-title').textContent : 'Reports';
                
                if (!activeSection) {
                  alert('No active report section found');
                  return;
                }
                
                const sectionId = activeSection.id;
                const categoryFilter = categoryFilters[sectionId];
                
                if (categoryFilter) {
                  const selectedCategory = categoryFilter.value;
                  
                  if (selectedCategory === 'all') {
                    // Export all visible tables in the section
                    const tables = activeSection.querySelectorAll('table');
                    let exportData = [];
                    
                    tables.forEach(table => {
                      const tableContainer = table.closest('.card-table');
                      if (tableContainer && tableContainer.style.display !== 'none') {
                        const tableHeader = tableContainer.querySelector('header').textContent;
                        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
                        const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
                          return Array.from(tr.querySelectorAll('td')).map(td => td.textContent);
                        });
                        
                        if (rows.length > 0 && !rows[0][0].includes('No data')) {
                          exportData.push({ title: tableHeader, headers, rows });
                        }
                      }
                    });
                    
                    if (exportData.length > 0) {
                      if (type === 'csv') {
                        exportAsCSV(exportData, sectionTitle);
                      } else if (type === 'xlsx') {
                        exportAsExcel(exportData, sectionTitle);
                      } else if (type === 'pdf') {
                        exportAsPDF(exportData, sectionTitle);
                      }
                    } else {
                      alert('No data to export');
                    }
                  } else {
                    // Export only the selected category
                    let targetElement = null;
                    
                    // Find the target element based on section and category
                    switch(sectionId) {
                      case 'sales-reports':
                        const salesTableMap = {
                          'salesByProduct': '#salesByProduct',
                          'salesByCategory': '#salesByCategory', 
                          'salesByEmployee': '#salesByEmployee',
                          'paymentBreakdown': '#paymentBreakdown'
                        };
                        const salesSelector = salesTableMap[selectedCategory];
                        if (salesSelector) {
                          targetElement = activeSection.querySelector(salesSelector)?.closest('.card-table');
                        }
                        break;
                      case 'inventory-reports':
                        const inventoryTableMap = {
                          'stockLevels': '#stockLevels',
                          'lowStock': '#lowStock',
                          'inventoryValuation': '#inventoryValuation',
                          'stockMovement': '#stockMovement'
                        };
                        const inventorySelector = inventoryTableMap[selectedCategory];
                        if (inventorySelector) {
                          targetElement = activeSection.querySelector(inventorySelector)?.closest('.card-table');
                        }
                        break;
                      case 'financial-reports':
                        if (selectedCategory === 'pnl') {
                          targetElement = activeSection.querySelector('.cards');
                        } else {
                          const financialTableMap = {
                            'taxReports': '#taxReports',
                            'refundsTable': '#refundsTable'
                          };
                          const financialSelector = financialTableMap[selectedCategory];
                          if (financialSelector) {
                            targetElement = activeSection.querySelector(financialSelector)?.closest('.card-table');
                          }
                        }
                        break;
                      case 'supplier-reports':
                        const supplierTableMap = {
                          'supplierPerformance': '#supplierPerformance',
                          'supplierPayments': '#spendingByCategory',
                          'supplierProducts': '#supplierProducts'
                        };
                        const supplierSelector = supplierTableMap[selectedCategory];
                        if (supplierSelector) {
                          targetElement = activeSection.querySelector(supplierSelector)?.closest('.card-table');
                        }
                        break;
                      case 'customer-reports':
                        const customerTableMap = {
                          'purchaseHistory': '#purchaseHistory',
                          'loyalty': '#loyalty',
                          'customerAnalytics': '#customerAnalytics'
                        };
                        const customerSelector = customerTableMap[selectedCategory];
                        if (customerSelector) {
                          targetElement = activeSection.querySelector(customerSelector)?.closest('.card-table');
                        }
                        break;
                    }
                    
                    if (!targetElement || targetElement.style.display === 'none') {
                      alert('Selected category is not visible or not found');
                      return;
                    }
                    
                    // Export the selected element
                    let exportData = [];
                    
                    if (selectedCategory === 'pnl' && sectionId === 'financial-reports') {
                      // Handle cards export differently
                      const cards = targetElement.querySelectorAll('.report-card');
                      const cardData = Array.from(cards).map(card => {
                        const label = card.querySelector('.label').textContent;
                        const value = card.querySelector('.value').textContent;
                        return [label, value];
                      });
                      
                      if (cardData.length > 0) {
                        exportData.push({ 
                          title: 'Profit & Loss Summary', 
                          headers: ['Metric', 'Value'], 
                          rows: cardData 
                        });
                      }
                    } else {
                      // Handle table export
                      const table = targetElement.querySelector('table');
                      if (table) {
                        const tableHeader = targetElement.querySelector('header').textContent;
                        const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
                        const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
                          return Array.from(tr.querySelectorAll('td')).map(td => td.textContent);
                        });
                        
                        if (rows.length > 0 && !rows[0][0].includes('No data')) {
                          exportData.push({ title: tableHeader, headers, rows });
                        }
                      }
                    }
                    
                    if (exportData.length > 0) {
                      const exportTitle = exportData[0].title;
                      if (type === 'csv') {
                        exportAsCSV(exportData, exportTitle);
                      } else if (type === 'xlsx') {
                        exportAsExcel(exportData, exportTitle);
                      } else if (type === 'pdf') {
                        exportAsPDF(exportData, exportTitle);
                      }
                    } else {
                      alert('No data to export for selected category');
                    }
                  }
                } else {
                  // Fallback for sections without category filters
                  const tables = activeSection.querySelectorAll('table');
                  let exportData = [];
                  
                  tables.forEach(table => {
                    const tableContainer = table.closest('.card-table');
                    if (tableContainer) {
                      const tableHeader = tableContainer.querySelector('header').textContent;
                      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
                      const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
                        return Array.from(tr.querySelectorAll('td')).map(td => td.textContent);
                      });
                      
                      if (rows.length > 0 && !rows[0][0].includes('No data')) {
                        exportData.push({ title: tableHeader, headers, rows });
                      }
                    }
                  });
                  
                  if (exportData.length > 0) {
                    if (type === 'csv') {
                      exportAsCSV(exportData, sectionTitle);
                    } else if (type === 'xlsx') {
                      exportAsExcel(exportData, sectionTitle);
                    } else if (type === 'pdf') {
                      exportAsPDF(exportData, sectionTitle);
                    }
                  } else {
                    alert('No data to export');
                  }
                }
              });
            });
            
            // Function to export as CSV
            function exportAsCSV(data, sectionTitle) {
              // Prepend UTF-8 BOM to ensure applications (Excel/LibreOffice) detect UTF-8 and render ‚Ç± correctly
              let csvContent = '\uFEFF';
              
              data.forEach(table => {
                csvContent += table.title + '\n';
                csvContent += table.headers.join(',') + '\n';
                
                table.rows.forEach(row => {
                  csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
                });
                
                csvContent += '\n';
              });
              
              const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.setAttribute('href', url);
              link.setAttribute('download', `${sectionTitle.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.csv`);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }

            // Function to export as Excel (offline)
            function exportAsExcel(data, sectionTitle) {
              if (window.XLSX && XLSX.utils && XLSX.writeFile) {
                // If a local XLSX library is later added, use it
                const wb = XLSX.utils.book_new();
                data.forEach(table => {
                  const wsData = [table.headers, ...table.rows];
                  const ws = XLSX.utils.aoa_to_sheet(wsData);
                  const range = XLSX.utils.decode_range(ws['!ref']);
                  const colWidths = [];
                  for (let C = range.s.c; C <= range.e.c; ++C) {
                    let maxWidth = 0;
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                      const cell = ws[XLSX.utils.encode_cell({ r: R, c: C })];
                      if (cell && cell.v) { maxWidth = Math.max(maxWidth, String(cell.v).length); }
                    }
                    colWidths.push({ wch: Math.min(Math.max(maxWidth + 2, 10), 50) });
                  }
                  ws['!cols'] = colWidths;
                  const safeSheetName = table.title.replace(/[:\\\/?*[\]]/g, '_').substring(0, 31);
                  XLSX.utils.book_append_sheet(wb, ws, safeSheetName);
                });
                const filename = `${sectionTitle.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, filename);
                return;
              }
              // Fallback: generate an Excel-friendly HTML file
              let html = '<html><head><meta charset="utf-8"><style>table{border-collapse:collapse} th,td{border:1px solid #999;padding:6px;font-size:12px} thead{background:#eee}</style></head><body>';
              html += `<h1>${sectionTitle}</h1>`;
              data.forEach(table => {
                html += `<h2>${table.title}</h2><table><thead><tr>`;
                table.headers.forEach(h => { html += `<th>${h}</th>`; });
                html += '</tr></thead><tbody>';
                table.rows.forEach(row => {
                  html += '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
                });
                html += '</tbody></table><br/>';
              });
              html += '</body></html>';
              const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = `${sectionTitle.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.xls`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }

           // Function to export as PDF (offline)
           function exportAsPDF(data, sectionTitle) {
             if (window.jspdf && window.jspdf.jsPDF) {
               const { jsPDF } = window.jspdf;
               const doc = new jsPDF();
               doc.setFont('helvetica');
               let yPosition = 20;
               const pageWidth = doc.internal.pageSize.getWidth();
               data.forEach((table, tableIndex) => {
                 doc.setFontSize(16);
                 doc.setFont(undefined, 'bold');
                 doc.setTextColor(41, 128, 185);
                 doc.text(table.title, pageWidth / 2, yPosition, { align: 'center' });
                 yPosition += 10;
                 doc.setFontSize(12);
                 doc.setFont(undefined, 'normal');
                 doc.setTextColor(100, 100, 100);
                 doc.text(`Report: ${sectionTitle}`, pageWidth / 2, yPosition, { align: 'center' });
                 yPosition += 10;
                 doc.setFontSize(10);
                 doc.setTextColor(150, 150, 150);
                 const today = new Date().toLocaleDateString();
                 doc.text(`Date: ${today}`, 14, yPosition);
                 yPosition += 6;
                 doc.setFontSize(11);
                 doc.setTextColor(0,0,0);
                 let x = 14;
                 table.headers.forEach(h => { doc.text(String(h), x, yPosition); x += 60; });
                 yPosition += 6;
                 table.rows.forEach(row => {
                   x = 14;
                   row.forEach(cell => { doc.text(String(cell), x, yPosition); x += 60; });
                   yPosition += 6;
                   if (yPosition > doc.internal.pageSize.getHeight() - 20) { doc.addPage(); yPosition = 20; }
                 });
                 yPosition += 10;
                 if (yPosition > doc.internal.pageSize.getHeight() - 20 && tableIndex < data.length - 1) { doc.addPage(); yPosition = 20; }
               });
               const filename = `${sectionTitle.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
               doc.save(filename);
               return;
             }
             // Fallback: open print-friendly view and let user "Save as PDF"
             const win = window.open('', '_blank');
             const style = 'body{font-family: Arial, sans-serif;color:#000;padding:16px} h1{font-size:20px} h2{margin:12px 0;font-size:16px} table{border-collapse:collapse;width:100%} th,td{border:1px solid #999;padding:6px;font-size:12px} thead{background:#eee}';
             let html = `<html><head><meta charset="utf-8"><title>${sectionTitle}</title><style>${style}</style></head><body>`;
             html += `<h1>${sectionTitle}</h1>`;
             data.forEach(table => {
               html += `<h2>${table.title}</h2><table><thead><tr>`;
               table.headers.forEach(h => { html += `<th>${h}</th>`; });
               html += `</tr></thead><tbody>`;
               table.rows.forEach(row => {
                 html += '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
               });
               html += `</tbody></table><br/>`;
             });
             html += '</body></html>';
             win.document.open();
             win.document.write(html);
             win.document.close();
             win.focus();
             win.print();
           }

            async function getStockMovements() {
              try {
                const res = await fetch('api/stock_movements.php', { method: 'GET' });
                const data = await res.json();
                if (res.ok && data.ok) return data.data || [];
              } catch {}
              try { return JSON.parse(localStorage.getItem('stockMovements') || '[]'); } catch { return []; }
            }
            async function getTransactions() {
              try {
                const res = await fetch('api/transactions.php', { method: 'GET' });
                const data = await res.json();
                if (res.ok && data.ok) return data.data || [];
              } catch {}
              try { return JSON.parse(localStorage.getItem('transactions') || '[]'); } catch { return []; }
            }
            function inRange(iso, startISO, endISO) {
              if (!startISO && !endISO) return true;
              const d = new Date(iso);
              const s = startISO ? new Date(`${startISO}T00:00:00`) : null;
              const e = endISO ? new Date(`${endISO}T23:59:59.999`) : null;
              return (!s || d >= s) && (!e || d <= e);
            }
            function fmtPeso(n) { return '‚Ç±' + Number(n || 0).toLocaleString(); }

            // Fetch suppliers list (for total supplier count)
            async function getSuppliers() {
              try {
                const res = await fetch('api/suppliers.php', { method: 'GET' });
                const data = await res.json();
                if (res.ok && data.ok) return data.data || [];
              } catch {}
              try { return JSON.parse(localStorage.getItem('suppliers') || '[]'); } catch { return []; }
            }

            // Render supplier KPI cards: Total Suppliers, Active Suppliers, Total Spent
            function renderSupplierCards(rows, suppliers) {
              const totalEl = document.getElementById('totalSuppliers');
              const activeEl = document.getElementById('activeSuppliers');
              const spentEl = document.getElementById('totalSpentSuppliers');
              if (!totalEl || !activeEl || !spentEl) return;

              const nonArchivedSuppliers = (suppliers || []).filter(s => String((s.status || 'active')).toLowerCase() !== 'archived');
              totalEl.textContent = String(nonArchivedSuppliers.length);

              const activeSet = new Set();
              let totalSpent = 0;
              (rows || []).forEach(r => {
                if (r.type !== 'IN') return;
                const name = (r.supplier || '').trim();
                if (name) activeSet.add(name);
                const qty = parseInt(r.qty) || 0;
                const unit = parseFloat(r.unitCost) || 0;
                totalSpent += qty * unit;
              });

              activeEl.textContent = String(activeSet.size);
              spentEl.textContent = fmtPeso(totalSpent);
            }

            // Render Supplier Performance table
            function renderSupplierPerformance(rows, startISO, endISO) {
              const body = document.getElementById('supplierPerformance');
              if (!body) return;

              const bySup = {};
              (rows || []).forEach(r => {
                if (r.type !== 'IN') return;
                const sup = (r.supplier || '‚Äî').trim() || '‚Äî';
                const cat = r.category || '‚Äî';
                bySup[sup] = bySup[sup] || { orders: 0, spent: 0, cats: new Set() };
                bySup[sup].orders += 1;
                bySup[sup].spent += (parseInt(r.qty) || 0) * (parseFloat(r.unitCost) || 0);
                bySup[sup].cats.add(cat);
              });

              const sups = Object.keys(bySup);
              if (!sups.length) { body.innerHTML = '<tr><td colspan="5">No data</td></tr>'; return; }

              const daysInRange = (startISO && endISO) ? Math.max(1, Math.round((new Date(`${endISO}T23:59:59.999`) - new Date(`${startISO}T00:00:00`)) / (24*60*60*1000)) + 0) : null;
              body.innerHTML = sups.map(s => {
                const orders = bySup[s].orders;
                const spent = bySup[s].spent;
                const aov = orders ? (spent / orders) : 0;
                const freq = daysInRange ? `${(orders / daysInRange).toFixed(2)} /day` : String(orders);
                const cats = Array.from(bySup[s].cats).join(', ') || '‚Äî';
                const rating = '‚Äî'; // No quality rating data captured yet
                return `
                  <tr>
                    <td>${s}</td>
                    <td>${cats}</td>
                    <td>${fmtPeso(aov)}</td>
                    <td>${freq}</td>
                    <td>${rating}</td>
                  </tr>
                `;
              }).join('');
            }

            function renderStockMovement(rows) {
              const body = document.getElementById('stockMovement');
              if (!body) return;
              if (!rows.length) { body.innerHTML = '<tr><td colspan="5">No data</td></tr>'; return; }
              body.innerHTML = rows.map(r => `
                <tr>
                  <td>${new Date(r.date).toLocaleString()}</td>
                  <td>${r.product}</td>
                  <td>${r.category || '‚Äî'}</td>
                  <td class="${r.type === 'IN' ? 'text-success' : 'text-danger'}">${r.type}</td>
                  <td class="${r.type === 'IN' ? 'text-success' : 'text-danger'}">${r.type === 'IN' ? '+' : '-'}${r.qty}</td>
                </tr>
              `).join('');
            }

            function renderInventoryValuation(rows) {
              const byCat = {};
              rows.forEach(r => { 
                byCat[r.category] = byCat[r.category] || { units: 0, cost: 0 }; 
                if (r.type === 'IN') {
                  byCat[r.category].units += parseInt(r.qty)||0;
                  byCat[r.category].cost += (parseInt(r.qty)||0) * (parseFloat(r.unitCost) || 0);
                }
              });
              const body = document.getElementById('inventoryValuation');
              if (!body) return;
              const cats = Object.keys(byCat);
              if (!cats.length) { body.innerHTML = '<tr><td colspan="3">No data</td></tr>'; return; }
              body.innerHTML = cats.map(c => `
                <tr>
                  <td>${c}</td>
                  <td>${byCat[c].units}</td>
                  <td>${fmtPeso(byCat[c].cost)}</td>
                </tr>
              `).join('');
            }

            // Fallback: derive simple product stock snapshot from movements when product catalog is empty
            function deriveProductsFromMovements(rows) {
              const map = {};
              (rows || []).forEach(r => {
                const name = r.product;
                if (!name) return;
                const qty = parseInt(r.qty) || 0;
                if (!map[name]) {
                  map[name] = { name, stock: 0, reorder_point: 0, category: r.category || undefined };
                }
                if (r.type === 'IN') map[name].stock += qty;
                else if (r.type === 'OUT') map[name].stock -= qty;
                if (!map[name].category && r.category) map[name].category = r.category;
              });
              return Object.values(map);
            }

            // Products fetcher and stock level renderers
            async function getProducts() {
              try {
                const res = await fetch('api/products.php', { method: 'GET' });
                const data = await res.json();
                if (res.ok && data.ok) return data.data || [];
              } catch {}
              try { return JSON.parse(localStorage.getItem('products') || '[]'); } catch { return []; }
            }
            function renderStockLevels(products) {
              const body = document.getElementById('stockLevels');
              if (!body) return;
              const rows = (products || []).map(p => `
                <tr>
                  <td>${p.name}</td>
                  <td>${Number(p.stock || 0)}</td>
                  <td>${(p.reorder_point != null) ? Number(p.reorder_point) : '‚Äî'}</td>
                </tr>
              `);
              body.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="3">No data</td></tr>';
            }
            function renderLowStock(products) {
              const body = document.getElementById('lowStock');
              if (!body) return;
              const items = (products || []).filter(p => {
                const stock = Number(p.stock || 0);
                const rp = (p.reorder_point != null && Number(p.reorder_point) > 0) ? Number(p.reorder_point) : 15; // default threshold fallback
                return stock <= rp;
              }).map(p => {
                const stock = Number(p.stock || 0);
                const rp = (p.reorder_point != null && Number(p.reorder_point) > 0) ? Number(p.reorder_point) : 15;
                const needed = Math.max(0, rp - stock);
                return `
                  <tr>
                    <td>${p.name}</td>
                    <td>${stock}</td>
                    <td>${needed}</td>
                  </tr>
                `;
              });
              body.innerHTML = items.length ? items.join('') : '<tr><td colspan="3">No data</td></tr>';
            }

            function renderSpendingBySupplier(rows) {
              const bySup = {};
              rows.forEach(r => { if (r.type !== 'IN') return; const k = r.supplier || '‚Äî'; bySup[k] = bySup[k] || { cats: new Set(), orders: 0, spent: 0 }; bySup[k].cats.add(r.category); bySup[k].orders += 1; bySup[k].spent += (parseInt(r.qty)||0) * (parseFloat(r.unitCost) || 0); });
              const body = document.getElementById('spendingBySupplier');
              if (!body) return;
              const sups = Object.keys(bySup);
              if (!sups.length) { body.innerHTML = '<tr><td colspan="4">No data</td></tr>'; return; }
              body.innerHTML = sups.map(s => `
                <tr>
                  <td>${s}</td>
                  <td>${Array.from(bySup[s].cats).join(', ') || '‚Äî'}</td>
                  <td>${bySup[s].orders}</td>
                  <td>${fmtPeso(bySup[s].spent)}</td>
                </tr>
              `).join('');
            }

            function renderSpendingByCategory(rows) {
              const byCat = {};
              rows.forEach(r => { if (r.type !== 'IN') return; byCat[r.category] = byCat[r.category] || { sups: new Set(), products: new Set(), spent: 0 }; byCat[r.category].sups.add(r.supplier || '‚Äî'); byCat[r.category].products.add(r.product); byCat[r.category].spent += (parseInt(r.qty)||0) * (parseFloat(r.unitCost) || 0); });
              const body = document.getElementById('spendingByCategory');
              if (!body) return;
              const cats = Object.keys(byCat);
              if (!cats.length) { body.innerHTML = '<tr><td colspan="4">No data</td></tr>'; return; }
              body.innerHTML = cats.map(c => `
                <tr>
                  <td>${c}</td>
                  <td>${byCat[c].sups.size}</td>
                  <td>${byCat[c].products.size}</td>
                  <td>${fmtPeso(byCat[c].spent)}</td>
                </tr>
              `).join('');
            }

            function renderSalesSections(rowsTx) {
              const rev = rowsTx.reduce((s,t)=>s+(parseFloat(t.total)||0),0);
              const count = rowsTx.length;
              const aov = count ? rev / count : 0;
              document.getElementById('revTotal').textContent = fmtPeso(rev);
              document.getElementById('txnCount').textContent = String(count);
              document.getElementById('aov').textContent = fmtPeso(aov);

              const byProduct = {};
              const byCategory = {};
              const byEmployee = {};
              const byPayment = {};
              rowsTx.forEach(t=>{
                byEmployee[t.cashier||'‚Äî'] = byEmployee[t.cashier||'‚Äî'] || { txns: 0, rev: 0 };
                byEmployee[t.cashier||'‚Äî'].txns += 1;
                byEmployee[t.cashier||'‚Äî'].rev += parseFloat(t.total)||0;
                byPayment[t.paymentMethod||'‚Äî'] = byPayment[t.paymentMethod||'‚Äî'] || { txns: 0, rev: 0 };
                byPayment[t.paymentMethod||'‚Äî'].txns += 1;
                byPayment[t.paymentMethod||'‚Äî'].rev += parseFloat(t.total)||0;
                (t.items||[]).forEach(it=>{
                  byProduct[it.product] = byProduct[it.product] || { qty: 0, rev: 0 };
                  byProduct[it.product].qty += parseInt(it.qty)||0;
                  byProduct[it.product].rev += (parseInt(it.qty)||0)*(parseFloat(it.price)||0);
                  const cat = (it.category||'').toLowerCase();
                  byCategory[cat] = byCategory[cat] || { qty: 0, rev: 0 };
                  byCategory[cat].qty += parseInt(it.qty)||0;
                  byCategory[cat].rev += (parseInt(it.qty)||0)*(parseFloat(it.price)||0);
                });
              });

              const sbp = document.getElementById('salesByProduct');
              const products = Object.keys(byProduct);
              sbp.innerHTML = products.length ? products.map(p=>`<tr><td>${p}</td><td>${byProduct[p].qty}</td><td>${fmtPeso(byProduct[p].rev)}</td></tr>`).join('') : '<tr><td colspan="3">No data</td></tr>';

              const sbc = document.getElementById('salesByCategory');
              const cats = Object.keys(byCategory);
              sbc.innerHTML = cats.length ? cats.map(c=>`<tr><td>${c||'‚Äî'}</td><td>${byCategory[c].qty}</td><td>${fmtPeso(byCategory[c].rev)}</td></tr>`).join('') : '<tr><td colspan="3">No data</td></tr>';

              const sbe = document.getElementById('salesByEmployee');
              const emps = Object.keys(byEmployee);
              sbe.innerHTML = emps.length ? emps.map(e=>`<tr><td>${e}</td><td>${byEmployee[e].txns}</td><td>${fmtPeso(byEmployee[e].rev)}</td></tr>`).join('') : '<tr><td colspan="3">No data</td></tr>';

              const pbd = document.getElementById('paymentBreakdown');
              const pms = Object.keys(byPayment);
              pbd.innerHTML = pms.length ? pms.map(m=>`<tr><td>${m}</td><td>${byPayment[m].txns}</td><td>${fmtPeso(byPayment[m].rev)}</td></tr>`).join('') : '<tr><td colspan="3">No data</td></tr>';

              const ph = document.getElementById('purchaseHistory');
              ph.innerHTML = rowsTx.length ? rowsTx.map(t=>{
                let customerDisplay = 'Walk-in';
                if (t.customer_id && t.customer_id !== '0' && t.customer_id !== '') {
                  customerDisplay = t.customer || t.customer_name || '‚Äî';
                } else if (t.customer && t.customer !== 'Walk-in' && t.customer !== '') {
                  customerDisplay = t.customer;
                }
                return `<tr><td>${new Date(t.date).toLocaleString()}</td><td>${customerDisplay}</td><td>${(t.items||[]).reduce((s,i)=>s+(parseInt(i.qty)||0),0)}</td><td>${fmtPeso(parseFloat(t.total)||0)}</td></tr>`;
              }).join('') : '<tr><td colspan="4">No data</td></tr>';
            }

            async function renderAll() {
              const allRows = await getStockMovements();
              const rows = (allRows || []).filter(r => inRange(r.date, from?.value, to?.value)).sort((a, b) => new Date(b.date) - new Date(a.date));
              renderStockMovement(rows);
              renderInventoryValuation(rows);
              const productsRaw = await getProducts();
              let products = productsRaw || [];
              if (!products.length) { products = deriveProductsFromMovements(rows); }
              renderStockLevels(products);
              renderLowStock(products);
              renderSpendingBySupplier(rows);
              renderSpendingByCategory(rows);

              const suppliers = await getSuppliers();
              renderSupplierCards(rows, suppliers);
              renderSupplierPerformance(rows, from?.value, to?.value);

              const txns = (await getTransactions()).filter(t => inRange(t.date, from?.value, to?.value)).sort((a, b) => new Date(b.date) - new Date(a.date));
              renderSalesSections(txns);
            }

            // initial render
            renderAll();
          })();
        </script>
      </main>
    </div>
    <script src="global.js"></script>
  </body>
</html>
