<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
  <link rel="stylesheet" href="../global.css" />
</head>
  <body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="brand">
          <img src="../gelo.png" alt="Gelo's Vape Shop logo" />
        </div>
        <nav class="nav">
          <ul class="nav-list">
            <li>
              <a href="dashboard.html" class="active"><span class="icon">üè†</span><span class="label">Dashboard</span></a>
            </li>
            <li class="has-submenu">
              <a href="inventory.html"><span class="icon">üì¶</span><span class="label">Inventory</span></a>
              <ul class="submenu">
                <li><a href="../product_list.html">Product List</a></li>
              </ul>
            </li>
            <li>
              <a href="pos.html"><span class="icon">üßæ</span><span class="label">POS</span></a>
            </li>
            <li>
              <a href="../customers.html"><span class="icon">üë•</span><span class="label">Customer</span></a>
            </li>
            <li>
              <a href="../suppliers.html"><span class="icon">üöö</span><span class="label">Suppliers</span></a>
            </li>
            <li class="has-submenu">
              <a href="../reports.php"><span class="icon">üìä</span><span class="label">Reports</span></a>
              <ul class="submenu">
                <li><a href="../reports.php#sales-reports">Sales Reports</a></li>
                <li><a href="../reports.php#inventory-reports">Inventory Reports</a></li>
                <li><a href="../reports.php#financial-reports">Financial Reports</a></li>
                <li><a href="../reports.php#supplier-reports">Supplier Reports</a></li>
                <li><a href="../reports.php#customer-reports">Customer Reports</a></li>
                <li><a href="../reports.php#operational-reports">Operational Reports</a></li>
              </ul>
            </li>
            <li>
              <a href="../settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a>
            </li>
            <li id="usersNav" style="display: none;">
              <a href="../users.html"><span class="icon">üë§</span><span class="label">Users</span></a>
            </li>
          </ul>
        </nav>
      </div>
      <a href="../index.html" class="logout"><span class="icon">‚éã</span><span class="label">Logout</span></a>
    </aside>

    <main class="main">
      <section class="filters">
        <div class="quick-filters">
          <button class="qf active" data-range="today">Today</button>
          <button class="qf" data-range="week">This Week</button>
          <button class="qf" data-range="month">This Month</button>
        </div>
      </section>

      <section class="kpis">
        <div class="kpi-card"><div class="label">Today's Sales</div><div class="value" id="kpiSales">‚Ç±0.00</div></div>
        <div class="kpi-card"><div class="label">Transactions</div><div class="value" id="kpiTxns">0</div></div>
        <div class="kpi-card"><div class="label">Top Product</div><div class="value" id="kpiTopProduct">‚Äî</div></div>
        <div class="kpi-card"><div class="label">Low Stock Items</div><div class="value" id="kpiLowStock">0</div></div>
      </section>

      <section class="charts-grid">
        <div class="card"><header>Sales Over Time</header><canvas id="chartSales"></canvas></div>
        <div class="card"><header>Best-Selling Products</header><canvas id="chartProducts"></canvas></div>
        <div class="card small-chart"><header>Sales by Category</header><canvas id="chartCategory"></canvas></div>
        <div class="card small-chart"><header>Payment Method Split</header><canvas id="chartPayments"></canvas></div>
      </section>

      <section class="lows-grid">
        <div class="card">
          <header>Low Stock List</header>
          <table>
            <thead><tr><th>Product</th><th>Qty Left</th><th></th></tr></thead>
            <tbody id="lowStockTable"><tr><td colspan="3">No low-stock items</td></tr></tbody>
          </table>
        </div>
        <div class="card">
          <header>Employee Leaderboard</header>
          <table>
            <thead><tr><th>Employee</th><th>Sales</th></tr></thead>
            <tbody id="employeeBoard"><tr><td colspan="2">No data</td></tr></tbody>
          </table>
        </div>
      </section>

      <section class="misc-grid">
        <div class="card"><header>Refunds / Voids Today</header><div class="big" id="refundsVoids">0</div></div>
        <div class="card"><header>Gross Profit Today</header><div class="big" id="grossProfit">‚Ç±0.00</div></div>
      </section>

       <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
       <script src="../global.js"></script>
      <script>
        // Show Users nav for admin only
        (async function() {
          try {
            const res = await fetch('../api/auth/me.php', { credentials: 'same-origin' });
            const data = await res.json();
            if (data.ok && data.user.role === 'admin') {
              document.getElementById('usersNav').style.display = 'block';
            }
          } catch (err) {
            console.error('Failed to check user role:', err);
          }
        })();
        (async function(){
          // Show connection error message
          function showConnectionError() {
            // Check if error message already exists
            if (document.querySelector('.connection-error')) return;
            
            const main = document.querySelector('.main');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'connection-error';
            errorDiv.innerHTML = `
              <div class="error-icon">‚ö†Ô∏è</div>
              <h2>Database Connection Error</h2>
              <p>Unable to connect to the database or retrieve data. This could be because:</p>
              <ul>
                <li>MySQL service is not running</li>
                <li>The database 'gelo_pos' does not exist</li>
                <li>Tables have not been created or initialized</li>
              </ul>
              <a href="../db_status.php" class="error-btn">Check Database Status</a>
            `;
            
            // Insert at the top of main content
            main.insertBefore(errorDiv, main.firstChild);
          }
          
          const fmt = n => `‚Ç±${Number(n||0).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;          const todayYMD = (()=>{ const d=new Date(); return d.toISOString().slice(0,10); })();
          async function getTxns(){ 
            try { 
              const r = await fetch('../api/transactions.php', { method:'GET' }); 
              const d = await r.json(); 
              if (!r.ok || !d.ok) {
                console.error('Error fetching transactions:', d.error || 'Unknown error');
                return [];
              }
              return d.data || [];
            } catch (err) { 
              console.error('Error fetching transactions:', err);
              try { 
                return JSON.parse(localStorage.getItem('transactions')||'[]'); 
              } catch { 
                return []; 
              } 
            } 
          }
          
          async function getMoves(){ 
            try { 
              const r = await fetch('../api/stock_in.php', { method:'GET' }); 
              const d = await r.json(); 
              if (!r.ok || !d.ok) {
                console.error('Error fetching stock movements:', d.error || 'Unknown error');
                return [];
              }
              return d.data || [];
            } catch (err) { 
              console.error('Error fetching stock movements:', err);
              try { 
                return JSON.parse(localStorage.getItem('stockMovements')||'[]'); 
              } catch { 
                return []; 
              } 
            } 
          }
          
          function sameDay(iso){ return (iso||'').slice(0,10) === todayYMD; }

          // Define loadCurrentStocks function before using it
          async function loadCurrentStocks(){
            try {
              const r = await fetch('../api/products.php');
              const d = await r.json();
              if (r.ok && d.ok) return (d.data||[]).map(p=>[p.name, p.stock||0]);
            } catch (err) {
              console.error('Error fetching products:', err);
            }
            return [];
          }
          
          // Fetch data and check for connection issues
          const txns = await getTxns();
          const moves = await getMoves();
          const currentStocks = await loadCurrentStocks();
          
          // Check if we have any data at all
          if (txns.length === 0 && moves.length === 0 && currentStocks.length === 0) {
            // Show connection error if all data sources are empty
            showConnectionError();
          } else {
            // Remove any existing error message if data is available
            const errorDiv = document.querySelector('.connection-error');
            if (errorDiv) errorDiv.remove();
          }
          
          // Rest of the dashboard code
          let productAggAll = {};
          
          const todays = txns.filter(t => sameDay(t.date||t.date_created));
          const salesToday = todays.reduce((s,t)=>s+Number(t.total||t.total_amount||0),0);
          const txnCount = todays.length;
          const productAggToday = {};
          const categoryAgg = {};
          const paymentAgg = { Cash: 0, GCash: 0 };
          todays.forEach(t=>{
            (t.items||[]).forEach(it=>{
              productAggToday[it.product] = (productAggToday[it.product]||0) + (it.qty||0);
              const cat = (it.category||'').toLowerCase();
              categoryAgg[cat] = (categoryAgg[cat]||0) + (it.qty||0);
            });
            const paymentMethod = t.payment_method || t.paymentMethod || 'Cash';
            if (paymentAgg.hasOwnProperty(paymentMethod)) {
              paymentAgg[paymentMethod] += Number(t.total || t.total_amount || 0);
            }
          });

          // KPIs
          document.getElementById('kpiSales').textContent = fmt(salesToday);
          document.getElementById('kpiTxns').textContent = String(txnCount);
          const topProd = Object.entries(productAggToday).sort((a,b)=>b[1]-a[1])[0];
          document.getElementById('kpiTopProduct').textContent = topProd ? `${topProd[0]} (${topProd[1]})` : '‚Äî';

          // Low stock (derive from movements vs baseline 10 if available)
          const low = currentStocks.filter(([_,qty])=>qty<=15);
          document.getElementById('kpiLowStock').textContent = String(low.length);
          const lowBody = document.getElementById('lowStockTable');
          if (low.length) {
            lowBody.innerHTML = low.map(([name,qty])=>`<tr><td>${name}</td><td>${qty}</td><td><a href="../product_list.html">View</a></td></tr>`).join('');
          } else {
            lowBody.innerHTML = '<tr><td colspan="3">No low-stock items</td></tr>';
          }

          // Charts
          const last7Labels = (()=>{ const d=new Date(); const arr=[]; for(let i=6;i>=0;i--){ const x=new Date(d); x.setDate(d.getDate()-i); arr.push(x.toLocaleDateString('en-PH',{month:'short',day:'numeric'})); } return arr; })();
          const salesByDay = (()=>{ const map=new Map(); for(let i=6;i>=0;i--){ const x=new Date(); x.setDate(x.getDate()-i); map.set(x.toISOString().slice(0,10),0); } txns.forEach(t=>{ const k=(t.date||t.date_created||'').slice(0,10); if(map.has(k)) map.set(k,(map.get(k)||0)+Number(t.total||t.total_amount||0)); }); return Array.from(map.values()); })();
          // Clear and reuse productAggAll
          productAggAll = {};
          const categoryAggAll = {};
          txns.forEach(t=>{
            (t.items||[]).forEach(it=>{
              productAggAll[it.product] = (productAggAll[it.product]||0) + (it.qty||0);
              const cat=(it.category||'').toLowerCase();
              categoryAggAll[cat] = (categoryAggAll[cat]||0) + (it.qty||0);
            });
          });
          const productData = { labels: Object.keys(productAggAll), values: Object.values(productAggAll) };
          const categoryData = { labels: Object.keys(categoryAggAll), values: Object.values(categoryAggAll) };
          const paymentData = { 
            labels: Object.keys(paymentAgg), 
            values: Object.values(paymentAgg).map(v => Number(v) || 0) 
          };

          // Distinct colors for each category label (prevents duplicates like 'units' and 'hardware')
          const categoryColorMap = {
            'units': '#3b82f6',       // blue
            'disposable': '#f97316',  // orange
            'e-juice': '#22c55e',     // green
            'hardware': '#a855f7'     // purple (changed to avoid conflict)
          };
          const categoryBg = (categoryData.labels || []).map(l => categoryColorMap[(l||'').toLowerCase().trim()] || '#94a3b8');

          const ctx1 = document.getElementById('chartSales');
          new Chart(ctx1, { type: 'line', data: { labels: last7Labels, datasets: [{ label: 'Sales', data: salesByDay, borderColor: '#4ade80', backgroundColor: 'rgba(74, 222, 128, .08)', fill: true, tension: .3 }] }, options: { plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#2a2a2a' }}, y: { beginAtZero: true, grid: { color: '#2a2a2a' }}} }});

          const ctx2 = document.getElementById('chartProducts');
          new Chart(ctx2, { type: 'bar', data: { labels: productData.labels, datasets: [{ data: productData.values, backgroundColor: '#60a5fa' }] }, options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { color: '#2a2a2a' }}, y: { grid: { color: '#2a2a2a' }}} }});

          const ctx3 = document.getElementById('chartCategory');
          new Chart(ctx3, { type: 'pie', data: { labels: categoryData.labels, datasets: [{ data: categoryData.values, backgroundColor: categoryBg }] }, options: { plugins: { legend: { position: 'bottom' }}} });

          const ctx4 = document.getElementById('chartPayments');
          new Chart(ctx4, { type: 'doughnut', data: { labels: paymentData.labels, datasets: [{ data: paymentData.values, backgroundColor: ['#fde047','#22c55e'] }] }, options: { cutout: '60%', plugins: { legend: { position: 'bottom' }}} });

          // Employee leaderboard (by cashier revenue today)
          const byCashier = {};
          todays.forEach(t=>{ 
            const k=t.cashier||t.cashier_name||'‚Äî'; 
            byCashier[k]=(byCashier[k]||0)+Number(t.total||t.total_amount||0); 
          });
          const empBody = document.getElementById('employeeBoard');
          const emp = Object.entries(byCashier).sort((a,b)=>b[1]-a[1]);
          empBody.innerHTML = emp.length? emp.map(([name,amt])=>`<tr><td>${name}</td><td>${fmt(amt)}</td></tr>`).join('') : '<tr><td colspan="2">No data</td></tr>';

          // Quick filters functionality
          document.querySelectorAll('.qf').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              document.querySelectorAll('.qf').forEach(b=>b.classList.remove('active'));
              btn.classList.add('active');
              
              const range = btn.getAttribute('data-range');
              let filteredTxns = [];
              
              if (range === 'today') {
                filteredTxns = txns.filter(t => sameDay(t.date || t.date_created));
              } else if (range === 'week') {
                const now = new Date();
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - 7);
                filteredTxns = txns.filter(t => {
                  const txDate = new Date(t.date || t.date_created || '');
                  return txDate >= weekStart && txDate <= now;
                });
              } else if (range === 'month') {
                const now = new Date();
                const monthStart = new Date(now);
                monthStart.setDate(now.getDate() - 30);
                filteredTxns = txns.filter(t => {
                  const txDate = new Date(t.date || t.date_created || '');
                  return txDate >= monthStart && txDate <= now;
                });
              }
              
              // Recalculate KPIs and charts based on filtered transactions
              updateDashboard(filteredTxns);
            });
          });
          
          // Function to update dashboard with filtered data
          function updateDashboard(filteredTxns) {
            // Update KPIs
            const salesToday = filteredTxns.reduce((s,t)=>s+Number(t.total||t.total_amount||0),0);
            const txnCount = filteredTxns.length;
            document.getElementById('kpiSales').textContent = fmt(salesToday);
            document.getElementById('kpiTxns').textContent = String(txnCount);
            
            // Update product aggregation
            const productAggFiltered = {};
            const categoryAggFiltered = {};
            const paymentAggFiltered = { Cash: 0, GCash: 0 };
            
            filteredTxns.forEach(t=>{
              (t.items||[]).forEach(it=>{
                productAggFiltered[it.product] = (productAggFiltered[it.product]||0) + (it.qty||0);
                const cat = (it.category||'').toLowerCase();
                categoryAggFiltered[cat] = (categoryAggFiltered[cat]||0) + (it.qty||0);
              });
              const paymentMethod = t.payment_method || t.paymentMethod || 'Cash';
              if (paymentAggFiltered.hasOwnProperty(paymentMethod)) {
                paymentAggFiltered[paymentMethod] += Number(t.total || t.total_amount || 0);
              }
            });
            
            // Update top product
            const topProd = Object.entries(productAggFiltered).sort((a,b)=>b[1]-a[1])[0];
            document.getElementById('kpiTopProduct').textContent = topProd ? `${topProd[0]} (${topProd[1]})` : '‚Äî';
            
            // Update employee leaderboard
            const byCashier = {};
            filteredTxns.forEach(t=>{ 
              const k=t.cashier||t.cashier_name||'‚Äî'; 
              byCashier[k]=(byCashier[k]||0)+Number(t.total||t.total_amount||0); 
            });
            const empBody = document.getElementById('employeeBoard');
            const emp = Object.entries(byCashier).sort((a,b)=>b[1]-a[1]);
            empBody.innerHTML = emp.length? emp.map(([name,amt])=>`<tr><td>${name}</td><td>${fmt(amt)}</td></tr>`).join('') : '<tr><td colspan="2">No data</td></tr>';
          }
          
          // Initial dashboard with today's data
          updateDashboard(todays);
        })();
      </script>
    </main>
  </div>
</body>
</html>


