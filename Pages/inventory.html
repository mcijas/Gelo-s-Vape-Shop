<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Inventory Management</title>
    <link rel="stylesheet" href="inventory.css" />
    <link rel="stylesheet" href="../global.css" />
  </head>
  <body>
    <div class="body">
      <div class="container">
        <aside class="sidebar">
          <div class="sidebar-top">
            <div class="brand">
              <img src="../gelo.png" alt="Gelo's Vape Shop logo" />
            </div>
            <nav class="nav">
              <ul class="nav-list">
                <li>
                  <a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a>
                </li>
                <li class="has-submenu">
                  <a href="inventory.html" class="active"><span class="icon">üì¶</span><span class="label">Inventory</span></a>
                  <ul class="submenu">
                    <li><a href="../product_list.html">Product List</a></li>
                  </ul>
                </li>
                <li>
                  <a href="pos.html"><span class="icon">üßæ</span><span class="label">POS</span></a>
                </li>
                <li>
                  <a href="../customers.html"><span class="icon">üë•</span><span class="label">Customer</span></a>
                </li>
                <li>
                  <a href="../suppliers.html"><span class="icon">üöö</span><span class="label">Suppliers</span></a>
                </li>
                <li class="has-submenu">
                <a href="../reports.php"><span class="icon">üìä</span><span class="label">Reports</span></a>
                  <ul class="submenu">
                    <li><a href="../reports.php#sales-reports">Sales Reports</a></li>
                    <li><a href="../reports.php#inventory-reports">Inventory Reports</a></li>
                    <li><a href="../reports.php#financial-reports">Financial Reports</a></li>
                    <li><a href="../reports.php#supplier-reports">Supplier Reports</a></li>
                    <li><a href="../reports.php#customer-reports">Customer Reports</a></li>
                    <li><a href="../reports.php#operational-reports">Operational Reports</a></li>
                  </ul>
                </li>
                <li>
              <a href="../settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a>
            </li>
            <li id="usersNav" style="display: none;">
              <a href="../users.html"><span class="icon">üë§</span><span class="label">Users</span></a>
            </li>
          </ul>
        </nav>
      </div>
      <a href="../index.html" class="logout"><span class="icon">‚éã</span><span class="label">Logout</span></a>
        </aside>

        <main class="main-content">
          <div class="toolbar">
            <div class="category-select">
              <select aria-label="Select category">
                <option value="all">All Categories</option>
                <option value="units">Units</option>
                <option value="disposable">Disposable</option>
                <option value="e-juice">E-juice</option>
                <option value="hardware">Hardware</option>
              </select>
            </div>
            <div class="search-bar">
              <input type="search" placeholder="Search products..." aria-label="Search products" />
              <button type="submit" aria-label="Search"><span class="icon search"></span></button>
            </div>
            <button class="add-product-btn" id="openAddProduct"><span class="icon add" aria-hidden="true"></span>Add Product</button>
            <button class="add-stock-btn" id="openAddStock" style="margin-left: 10px; background: linear-gradient(135deg, #059669, #047857); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(5, 150, 105, 0.3); transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(5, 150, 105, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(5, 150, 105, 0.3)'"><span class="icon add" aria-hidden="true"></span>Add Stock</button>
          </div>
          <div class="product-grid" id="invGrid"></div>
          <div id="addProductOverlay" class="overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); align-items:center; justify-content:center; z-index:1000;">
            <div class="modal" style="width:900px; max-width:95vw; max-height:95vh; background:#262626; border:1px solid #333; border-radius:12px; overflow:hidden; position:relative; box-shadow:0 20px 60px rgba(0,0,0,.5);">
              <button type="button" id="closeAddProduct" style="position:absolute; top:8px; right:10px; width:32px; height:32px; border-radius:6px; border:1px solid #3a3a3a; background:#1f2223; color:#e7e7e7; cursor:pointer;">√ó</button>
              <iframe src="../add_products.html" title="Add Product" style="width:100%; height:80vh; border:0; display:block; background:#262626"></iframe>
            </div>
          </div>

          <div id="addStockOverlay" class="overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); align-items:center; justify-content:center; z-index:1000;">
            <div class="modal" style="width:500px; max-width:95vw; background:#262626; border:1px solid #333; border-radius:12px; padding:30px; box-shadow:0 20px 60px rgba(0,0,0,.5);">
              <h2 style="color:#e7e7e7; margin-bottom:20px;">Add Stock to Existing Product</h2>
              <form id="addStockForm">
                <div style="margin-bottom:15px;">
                  <label style="color:#e7e7e7; display:block; margin-bottom:5px;">Product</label>
                  <select id="stockProductSelect" style="width:100%; padding:10px; background:#1f2223; color:#e7e7e7; border:1px solid #3a3a3a; border-radius:6px;">
                    <option value="">Select a product...</option>
                  </select>
                </div>
                <div style="margin-bottom:15px;">
                  <label style="color:#e7e7e7; display:block; margin-bottom:5px;">Quantity</label>
                  <input type="number" id="stockQuantity" min="1" value="1" style="width:100%; padding:10px; background:#1f2223; color:#e7e7e7; border:1px solid #3a3a3a; border-radius:6px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="color:#e7e7e7; display:block; margin-bottom:5px;">Unit Cost (Optional)</label>
                  <input type="number" id="stockUnitCost" min="0" step="0.01" placeholder="0.00" style="width:100%; padding:10px; background:#1f2223; color:#e7e7e7; border:1px solid #3a3a3a; border-radius:6px;">
                </div>
                <div style="margin-bottom:15px;">
                  <label style="color:#e7e7e7; display:block; margin-bottom:5px;">Date</label>
                  <input type="date" id="stockDate" style="width:100%; padding:10px; background:#1f2223; color:#e7e7e7; border:1px solid #3a3a3a; border-radius:6px;">
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                  <button type="button" id="closeAddStock" style="padding:10px 20px; background:#3a3a3a; color:#e7e7e7; border:none; border-radius:6px; cursor:pointer;">Cancel</button>
                  <button type="submit" style="padding:10px 20px; background:#059669; color:white; border:none; border-radius:6px; cursor:pointer;">Add Stock</button>
                </div>
              </form>
            </div>
          </div>
          
          <!-- Edit Product Modal (Enhanced) -->
          <div id="editProductModal" class="overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px); align-items:center; justify-content:center; z-index:1000;">
            <div class="modal" style="width:800px; max-width:95vw; background:#262626; border:1px solid #333; border-radius:12px; padding:30px; box-shadow:0 20px 60px rgba(0,0,0,.5);">
              <button type="button" class="close-modal" onclick="closeEditProduct()" style="position:absolute; top:8px; right:10px; width:32px; height:32px; border-radius:6px; border:1px solid #3a3a3a; background:#1f2223; color:#e7e7e7; cursor:pointer;">√ó</button>
              <h2 style="color:#e7e7e7; margin-bottom:20px;">Edit Product & Manage Stock</h2>
              
              <div style="display:grid; grid-template-columns:1fr 200px; gap:30px;">
                <div>
                  <form id="editProductForm" enctype="multipart/form-data">
                    <input type="hidden" id="editProductId">
                    <div style="margin-bottom:15px;">
                      <label style="color:#e7e7e7; display:block; margin-bottom:5px;">Product Name</label>
                      <input type="text" id="editProductName" style="width:100%; padding:10px; background:#1f2223; color:#e7e7e7; border:1px solid #3a3a3a; border-radius:6px;" required>
                    </div>
                    <div style="margin-bottom:15px;">
                      <label style="color:#e7e7e7; display:block; margin-bottom:5px;">Category</label>
                      <input type="text" id="editProductCategory" style="width:100%; padding:10px; background:#1f2223; color:#e7e7e7; border:1px solid #3a3a3a; border-radius:6px;" required>
                    </div>
                    <div style="margin-bottom:15px;">
                      <label style="color:#e7e7e7; display:block; margin-bottom:5px;">Price (‚Ç±)</label>
                      <input type="number" id="editProductPrice" step="0.01" style="width:100%; padding:10px; background:#1f2223; color:#e7e7e7; border:1px solid #3a3a3a; border-radius:6px;" required>
                    </div>
                    <div style="margin-bottom:15px;">
                      <label style="color:#e7e7e7; display:block; margin-bottom:5px;">Current Stock</label>
                      <input type="number" id="editProductStock" min="0" style="width:100%; padding:10px; background:#1f2223; color:#e7e7e7; border:1px solid #3a3a3a; border-radius:6px;" required>
                    </div>
                    
                    <!-- Image Upload Section -->
                    <div style="margin-bottom:15px;">
                      <label style="color:#e7e7e7; display:block; margin-bottom:5px;">Product Image</label>
                      <input type="file" id="editProductImage" accept="image/jpeg,image/png" style="width:100%; padding:10px; background:#1f2223; color:#e7e7e7; border:1px solid #3a3a3a; border-radius:6px;">
                      <small style="color:#a3a3a3; font-size:12px;">JPG or PNG, max 5MB</small>
                    </div>
                    
                    <div style="margin-bottom:15px; display:grid; grid-template-columns:1fr auto; gap:10px; align-items:end;">
                      <div>
                        <label style="color:#e7e7e7; display:block; margin-bottom:5px;">Add Stock</label>
                        <input type="number" id="addStockAmount" min="1" value="1" style="width:100%; padding:10px; background:#1f2223; color:#e7e7e7; border:1px solid #3a3a3a; border-radius:6px;">
                      </div>
                      <button type="button" onclick="addStock()" style="padding:10px 20px; background:#059669; color:white; border:none; border-radius:6px; cursor:pointer;">Add Stock</button>
                    </div>
                    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                      <button type="button" onclick="closeEditProduct()" style="padding:10px 20px; background:#3a3a3a; color:#e7e7e7; border:none; border-radius:6px; cursor:pointer;">Cancel</button>
                      <button type="submit" style="padding:10px 20px; background:#059669; color:white; border:none; border-radius:6px; cursor:pointer;">Save Changes</button>
                    </div>
                  </form>
                </div>
                
                <!-- Product Image Preview -->
                <div style="display:flex; flex-direction:column; align-items:center;">
                  <div style="background:#1f2223; border:1px solid #3a3a3a; border-radius:8px; padding:15px; width:100%; text-align:center;">
                    <img id="editProductImagePreview" src="../img/rectangle-10.png" alt="Product" style="max-width:100%; max-height:150px; object-fit:contain; border-radius:6px;">
                  </div>
                  <button type="button" onclick="document.getElementById('editProductImage').click()" style="margin-top:10px; padding:8px 16px; background:#3a3a3a; color:#e7e7e7; border:none; border-radius:6px; cursor:pointer; font-size:12px;">Change Image</button>
                </div>
              </div>
            </div>
          </div>
          <script>
            let products = {};
              let currentEditProduct = null;
            (function() {
              const select = document.querySelector('.category-select select');
              const grid = document.getElementById('invGrid');
              function fmt(n){ return '‚Ç±' + Number(n||0).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
              // No default products; show only database products
              function cardHtml(p){
                return `
                  <article class="product-card" data-category="${(p.category||'').toLowerCase()}" data-product-id="${p.id}" style="cursor: pointer;">
                    <img src="${p.image_url ? '../' + p.image_url : '../img/rectangle-10.png'}" alt="${p.name}" class="product-image" />
                    <h3 class="product-name">${p.name}</h3>
                    <p class="product-category">Category: ${(p.category||'‚Äî')}</p>
                    <p class="product-stock">Stock: ${p.stock||0} units</p>
                    <p class="product-price">${fmt(p.price||0)}</p>
                  </article>`;
              }
              function applyFilter(){
                const v = (select && select.value) || 'all';
                if (!grid) return;
                Array.from(grid.children).forEach(card=>{
                  const cat = (card.getAttribute('data-category')||'');
                  card.style.display = (v==='all' || v===cat)? '' : 'none';
                });
              }
              async function load(){
                try {
                  const res = await fetch('../api/products.php');
                  const data = await res.json();
                  console.log('Loaded products:', data);
                  const list = (res.ok && data.ok) ? (data.data||[]) : [];
                  products = list.reduce((acc, p) => ({ ...acc, [parseInt(p.id)]: p }), {});
                  console.log('Processed products map:', products);
                  
                  // Debug: show all product IDs
                  list.forEach(p => {
                    console.log(`Product: ${p.name}, ID: ${p.id} (type: ${typeof p.id}), Parsed: ${parseInt(p.id)}`);
                  });
                  
                  if (grid) {
                    if (list.length) {
                      grid.innerHTML = '';
                      list.forEach(p => {
                        const card = document.createElement('div');
                        card.innerHTML = cardHtml(p);
                        const article = card.firstElementChild;
                        article.setAttribute('data-product-id', p.id);
                        article.addEventListener('click', () => {
                          console.log('Clicked product with ID:', p.id, 'type:', typeof p.id);
                          openEditProduct(parseInt(p.id));
                        });
                        grid.appendChild(article);
                      });
                    } else {
                      grid.innerHTML = '<div style="color:#a3a3a3; padding:20px">No products found. Add products to see them here.</div>';
                    }
                  }
                  applyFilter();
                } catch(err) {
                  console.error('Error loading products:', err);
                  if (grid) grid.innerHTML = '<div style="color:#a3a3a3; padding:20px">Unable to load products.</div>';
                  applyFilter();
                }
              }
              select?.addEventListener('change', applyFilter);
              load();

              function openEditProduct(productId) {
                const product = products[productId];
                if (!product) {
                  console.error('Product not found with ID:', productId);
                  return;
                }
                
                console.log('Opening edit for product:', product);
                currentEditProduct = product;
                document.getElementById('editProductId').value = product.id;
                document.getElementById('editProductName').value = product.name;
                document.getElementById('editProductCategory').value = product.category || '';
                document.getElementById('editProductPrice').value = product.price || 0;
                document.getElementById('editProductStock').value = product.stock || 0;
                
                // Set image preview
                const imagePreview = document.getElementById('editProductImagePreview');
                if (product.image_url) {
                  imagePreview.src = '../' + product.image_url;
                } else {
                  imagePreview.src = '../img/rectangle-10.png';
                }
                
                document.getElementById('editProductModal').style.display = 'flex';
              }

              // Handle image file selection
              document.getElementById('editProductImage').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                    document.getElementById('editProductImagePreview').src = e.target.result;
                  };
                  reader.readAsDataURL(file);
                }
              });

              document.getElementById('editProductForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const productId = parseInt(document.getElementById('editProductId').value);
                console.log('Updating product with ID:', productId, 'Type:', typeof productId);
                
                if (!productId || productId <= 0) {
                  alert('Invalid product ID: ' + productId);
                  return;
                }
                
                const formData = new FormData();
                formData.append('id', productId);
                formData.append('name', document.getElementById('editProductName').value);
                formData.append('category', document.getElementById('editProductCategory').value);
                formData.append('price', parseFloat(document.getElementById('editProductPrice').value));
                formData.append('stock', parseInt(document.getElementById('editProductStock').value));
                
                const imageFile = document.getElementById('editProductImage').files[0];
                if (imageFile) {
                  formData.append('image', imageFile);
                }

                try {
                  // Try PATCH first (for APIs that support method)
                  let response = await fetch('../api/products.php', { method: 'PATCH', body: formData });
                  let res = await response.json().catch(() => ({ ok:false, error:'Invalid JSON from PATCH' }));
                  
                  if (!response.ok || !res.ok) {
                    console.warn('PATCH failed or not supported, falling back to POST with method override', res);
                    const fd2 = new FormData();
                    for (const [k,v] of formData.entries()) fd2.append(k, v);
                    fd2.append('_method', 'PATCH');
                    // Many PHP handlers treat POST with _method override as update and allow $_FILES
                    response = await fetch('../api/products.php', { method: 'POST', body: fd2 });
                    res = await response.json().catch(() => ({ ok:false, error:'Invalid JSON from POST fallback' }));
                  }

                  console.log('Update response (final):', res);
                  if (res && res.ok) {
                    closeEditProduct();
                    await load();
                    alert('Product updated successfully');
                  } else {
                    alert('Error updating product: ' + ((res && res.error) || ('HTTP ' + (response && response.status)) || 'Unknown error'));
                  }
                } catch(err) {
                  console.error('Network error:', err);
                  alert('Network error: ' + err.message);
                }
              });

              function closeEditProduct() {
                document.getElementById('editProductModal').style.display = 'none';
                const form = document.getElementById('editProductForm');
                if (form) form.reset();
                currentEditProduct = null;
              }

              async function addStock(){
                const productId = parseInt(document.getElementById('editProductId').value);
                const qty = parseInt(document.getElementById('addStockAmount').value || '0', 10);
                if (!currentEditProduct || !productId || productId <= 0) {
                  alert('No product selected');
                  return;
                }
                if (!qty || qty <= 0) {
                  alert('Enter a valid quantity');
                  return;
                }
                try {
                  const payload = {
                    product: currentEditProduct.name,
                    category: currentEditProduct.category || '',
                    qty: qty,
                    unitCost: currentEditProduct.price || 0,
                    date: new Date().toISOString().split('T')[0]
                  };
                  const r = await fetch('../api/stock_in.php', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                  });
                  const j = await r.json();
                  if (r.ok && j.ok) {
                    if (products[productId]) {
                      products[productId].stock = (parseInt(products[productId].stock||0,10) + qty);
                    }
                    document.getElementById('editProductStock').value = parseInt(document.getElementById('editProductStock').value||0,10) + qty;
                    document.getElementById('addStockAmount').value = 1;
                    await load();
                    alert('Stock added successfully');
                  } else {
                    alert('Failed to add stock: ' + (j.error || ('HTTP ' + r.status)));
                  }
                } catch (e) {
                  console.error(e);
                  alert('Network error adding stock: ' + e.message);
                }
              }

              // Make functions globally available for inline handlers
              window.openEditProduct = openEditProduct;
              window.closeEditProduct = closeEditProduct;
              window.addStock = addStock;

              // Add Product overlay
            const overlay = document.getElementById('addProductOverlay');
            const openBtn = document.getElementById('openAddProduct');
            const closeBtn = document.getElementById('closeAddProduct');
            function open(){ overlay.style.display = 'flex'; }
            function close(){ overlay.style.display = 'none'; load(); }
            if (openBtn) openBtn.addEventListener('click', open);
            if (closeBtn) closeBtn.addEventListener('click', close);
            overlay.addEventListener('click', (e)=>{ if (e.target === overlay) close(); });
            document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
            window.addEventListener('message', (e)=>{ if (e && e.data && e.data.type==='close-add-product') close(); });

            // Add Stock overlay
            const stockOverlay = document.getElementById('addStockOverlay');
            const openStockBtn = document.getElementById('openAddStock');
            const closeStockBtn = document.getElementById('closeAddStock');
            const stockForm = document.getElementById('addStockForm');
            const stockProductSelect = document.getElementById('stockProductSelect');

            async function loadProductsForStock() {
              try {
                const res = await fetch('../api/products.php');
                const data = await res.json();
                const products = (res.ok && data.ok) ? (data.data||[]) : [];
                stockProductSelect.innerHTML = '<option value="">Select a product...</option>';
                products.forEach(product => {
                  const option = document.createElement('option');
                  option.value = product.name;
                  option.textContent = `${product.name} (${product.category || 'No category'}) - Current: ${product.stock || 0} units`;
                  stockProductSelect.appendChild(option);
                });
              } catch (error) {
                console.error('Error loading products:', error);
              }
            }

            function openStock() { 
              stockOverlay.style.display = 'flex'; 
              loadProductsForStock();
            }
            function closeStock() { stockOverlay.style.display = 'none'; }

            if (openStockBtn) openStockBtn.addEventListener('click', openStock);
            if (closeStockBtn) closeStockBtn.addEventListener('click', closeStock);
            stockOverlay.addEventListener('click', (e)=>{ if (e.target === stockOverlay) closeStock(); });
            document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeStock(); });

            stockForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const product = stockProductSelect.value;
              const qty = parseInt(document.getElementById('stockQuantity').value);
              const unitCost = parseFloat(document.getElementById('stockUnitCost').value) || 0;
              const date = document.getElementById('stockDate').value || new Date().toISOString().split('T')[0];

              if (!product || qty <= 0) {
                alert('Please select a product and enter a positive quantity');
                return;
              }

              try {
                const res = await fetch('../api/stock_in.php', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'same-origin',
                  body: JSON.stringify({
                    product: product,
                    qty: qty,
                    unitCost: unitCost,
                    date: date
                  })
                });
                const data = await res.json();
                if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to add stock');
                
                alert('Stock added successfully!');
                closeStock();
                load(); // Reload products to show updated stock
              } catch (error) {
                alert('Error adding stock: ' + error.message);
              }
            });
            })();
            // Reflect stock changes from stockMovements onto product cards
            (function(){
              function getMoves(){ try { return JSON.parse(localStorage.getItem('stockMovements')||'[]'); } catch { return []; } }
              function recompute(){
                const moves = getMoves();
                document.querySelectorAll('.product-card').forEach(card=>{
                  const name = card.querySelector('.product-name')?.textContent.trim();
                  const stockP = card.querySelector('.product-stock');
                  if (!name || !stockP) return;
                  const baseMatch = stockP.textContent.match(/(\d+)/);
                  const baseline = baseMatch ? parseInt(stockP.getAttribute('data-baseline')||baseMatch[1]) : 0;
                  let qty = baseline;
                  moves.forEach(m=>{
                    if ((m.product||'').trim() !== name) return;
                    if (m.type==='IN') qty += m.qty||0;
                    if (m.type==='OUT') qty = Math.max(0, qty - (m.qty||0));
                  });
                  stockP.setAttribute('data-baseline', String(baseline));
                  stockP.textContent = `Stock: ${qty} units`;
                });
              }
              window.addEventListener('storage', recompute);
              recompute();
            })();
            
            // Show Users nav for admin only
            (async function() {
              try {
                const res = await fetch('../api/auth/me.php', { credentials: 'same-origin' });
                const data = await res.json();
                if (data.ok && data.user.role === 'admin') {
                  document.getElementById('usersNav').style.display = 'block';
                }
              } catch (err) {
                console.error('Failed to check user role:', err);
              }
            })();
          </script>
        </main>
      </div>
    </div>
  </body>
  </html>


