<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>POS System - Gelo's Vape Shop</title>
    <link rel="stylesheet" href="../global.css" />
    <link rel="stylesheet" href="../pos.css" />
    <!-- QZ Tray for automatic thermal printing -->
    <script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2.4/qz-tray.min.js"></script>
    <style>
      /* Operational Controls Buttons */
      .ops-controls { gap: 8px; flex-wrap: wrap; }
      .ops-button {
        border: none;
        border-radius: 12px;
        padding: 10px 14px;
        font-weight: 700;
        color: #fff;
        cursor: pointer;
        transition: transform .12s ease, opacity .12s ease, box-shadow .12s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        line-height: 1;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        min-height: 38px;
        user-select: none;
      }
      .ops-button:hover { transform: translateY(-1px) scale(1.02); opacity: .95; }
      .ops-button:active { transform: scale(.98); opacity: .9; }
      .ops-button.green { background: #16a34a; }
      .ops-button.red { background: #dc2626; }
      .ops-button.blue { background: #2563eb; }
      .ops-button.purple { background: #7c3aed; }
      .ops-button.orange { background: #f97316; }
      @media (max-width: 600px) {
        .ops-controls { gap: 6px !important; }
        .ops-button { padding: 9px 12px; border-radius: 10px; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <aside class="sidebar">
        <div class="sidebar-top">
          <div class="brand"><img src="../gelo.png" alt="Gelo's Vape Shop logo" /></div>
          <nav class="nav">
            <ul class="nav-list">
              <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
              <li class="has-submenu">
                <a href="inventory.html"><span class="icon">üì¶</span><span class="label">Inventory</span></a>
                <ul class="submenu">
                  <li><a href="../product_list.html">Product List</a></li>
                </ul>
              </li>
              <li><a href="pos.html" class="active"><span class="icon">üßæ</span><span class="label">POS</span></a></li>
              <li><a href="../customers.html"><span class="icon">üë•</span><span class="label">Customer</span></a></li>
              <li><a href="../suppliers.html"><span class="icon">üöö</span><span class="label">Suppliers</span></a></li>
              <li class="has-submenu">
                <a href="../reports.php"><span class="icon">üìä</span><span class="label">Reports</span></a>
                <ul class="submenu">
                  <li><a href="../reports.php#sales-reports">Sales Reports</a></li>
                  <li><a href="../reports.php#inventory-reports">Inventory Reports</a></li>
                  <li><a href="../reports.php#financial-reports">Financial Reports</a></li>
                  <li><a href="../reports.php#supplier-reports">Supplier Reports</a></li>
                  <li><a href="../reports.php#customer-reports">Customer Reports</a></li>
                  <li><a href="../reports.php#operational-reports">Operational Reports</a></li>
                </ul>
              </li>
              <li><a href="../settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
            </ul>
          </nav>
        </div>
        <a href="../index.html" class="logout"><span class="icon">‚éã</span><span class="label">Logout</span></a>
      </aside>

      <main class="main-content pos-content">
        <div class="toolbar">
          <div class="search-bar">
            <input id="productSearch" type="search" placeholder="Search products..." aria-label="Search products" />
            <button type="submit" aria-label="Search"><span class="icon search"></span></button>
          </div>
          <div class="category-select">
            <select id="categoryFilter" aria-label="Select category">
              <option value="all">All Categories</option>
              <option value="units">Units</option>
              <option value="disposable">Disposable</option>
              <option value="e-juice">E-juice</option>
              <option value="hardware">Hardware</option>
            </select>
          </div>
          <div class="refresh-section">
            <button type="button" id="refreshStockBtn" aria-label="Refresh stock from database" title="Refresh stock levels">
              üîÑ Refresh Stock
            </button>
          </div>
          <div class="ops-controls" style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap">
            <button type="button" id="startShiftBtn" class="ops-button green" title="Start Shift">üü¢ Start Shift</button>
            <button type="button" id="endShiftBtn" class="ops-button red" title="End Shift">üî¥ End Shift</button>
            <button type="button" id="voidCartBtn" class="ops-button orange" title="Void Cart (discard current cart before checkout)">üóëÔ∏è Void Cart</button>
            <button type="button" id="refundBtn" class="ops-button purple" title="Refund / Return (requires receipt)">‚Ü©Ô∏è Refund/Return</button>
            <button type="button" id="printerSettingsBtn" class="ops-button blue" title="Printer Settings">üñ®Ô∏è Printer</button>
            <button type="button" id="testReceiptBtn" class="ops-button green" title="Test Receipt Preview">üìÑ Test Receipt</button>
          </div>
        </div>

        <section class="pos-layout">
          <div class="product-grid" id="productGrid">
            <!-- Products will be loaded dynamically -->
          </div>

          <aside class="cart-panel">
            <div class="cart-card">
              <h2 class="cart-title">Selected Products</h2>
              <div class="customer-row">
                <label for="posCustomer">Customer</label>
                <input id="posCustomer" list="posCustomerList" placeholder="Walk-in" />
                <datalist id="posCustomerList"></datalist>
              </div>
              <div class="table-wrap">
                <table class="cart-table" aria-describedby="cartTotals">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Product Code</th>
                      <th>Price</th>
                      <th class="qty-col">Quantity</th>
                      <th>Subtotal</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="cartBody"></tbody>
                </table>
              </div>

              <div class="totals-grid" id="cartTotals">
                <div class="metric"><span>Total Item</span><strong id="totalItems">00</strong></div>
                <div class="metric"><span>Total Qty</span><strong id="totalQty">00</strong></div>
                <div class="metric"><span>Discount</span><strong id="discount">00.00</strong></div>
                <div class="metric inputlike"><span>Coupon</span><strong id="coupon">00.00</strong></div>
                <div class="metric inputlike"><span>Tax</span><strong id="tax">00.00</strong></div>
                <div class="metric inputlike"><span>Shipping</span><strong id="shipping">00.00</strong></div>
              </div>

              <div class="grand-total">
                <span>Grand Total:</span>
                <strong id="grandTotal">0.00</strong>
              </div>

              <div class="pay-actions">
                <button class="pay-btn cash">Cash</button>
                <button class="pay-btn gcash">GCash</button>
              </div>

              <label class="barcode-toggle"><input type="checkbox" id="enableScanner"/> Enable Barcode Scanner</label>
            </div>
          </aside>
        </section>
      </main>
    </div>
    <script src="../global.js"></script>
    <script>
      (function() {
        const currency = (n) => `‚Ç±${n.toFixed(2)}`;
        let currentUserName = 'Admin';
        // Fetch current user for cashier name and guard page
        (async function ensureAuth(){
          try {
            const res = await fetch('../api/auth/me.php', { credentials: 'same-origin' });
            const data = await res.json();
            if (!res.ok || !data.ok) throw new Error('not auth');
            currentUserName = data.user?.name || sessionStorage.getItem('userName') || 'Admin';
          } catch (_) {
            const name = sessionStorage.getItem('userName');
            if (name) { currentUserName = name; }
            else { window.location.href = '../index.html'; }
          }
        })();
        const cart = new Map();

        function render() {
          const tbody = document.getElementById('cartBody');
          tbody.innerHTML = '';
          let totalQty = 0; let total = 0;
          for (const [code, item] of cart) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="c-name">${item.name}</td>
              <td class="c-code">${code}</td>
              <td class="c-price">${currency(item.price)}</td>
              <td class="c-qty">
                <div class="qty">
                  <button class="minus" aria-label="Decrease">‚Äπ</button>
                  <input type="number" min="1" value="${item.qty}" aria-label="Quantity" />
                  <button class="plus" aria-label="Increase">‚Ä∫</button>
                </div>
              </td>
              <td class="c-sub">${currency(item.price * item.qty)}</td>
              <td class="c-del">
                <button class="del icon-btn" aria-label="Remove item" title="Remove">
                  <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M9 3H15C15.5523 3 16 3.44772 16 4V5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H4C3.44772 7 3 6.55228 3 6C3 5.44772 3.44772 5 4 5H8V4C8 3.44772 8.44772 3 9 3Z" fill="currentColor"/>
                    <path d="M6 9H18L17.1066 19.2075C17.0478 19.8817 16.488 20.4 15.8111 20.4H8.18888C7.51204 20.4 6.9522 19.8817 6.8934 19.2075L6 9Z" fill="currentColor"/>
                  </svg>
                </button>
              </td>`;
            tbody.appendChild(tr);

            // events
            tr.querySelector('.minus').addEventListener('click', () => {
              updateQty(code, item.qty - 1);
            });
            tr.querySelector('.plus').addEventListener('click', () => {
              updateQty(code, item.qty + 1);
            });
            tr.querySelector('input').addEventListener('change', (e) => {
              updateQty(code, parseInt(e.target.value || '1', 10));
            });
            tr.querySelector('.del').addEventListener('click', () => {
              cart.delete(code); render();
            });

            totalQty += item.qty; total += item.qty * item.price;
          }
          document.getElementById('totalItems').textContent = String(cart.size).padStart(2,'0');
          document.getElementById('totalQty').textContent = String(totalQty).padStart(2,'0');
          document.getElementById('grandTotal').textContent = currency(total);
        }

        function updateQty(code, qty) {
          if (!cart.has(code)) return;
          const item = cart.get(code);
          
          // Find the product card to get actual stock
          const productCard = document.querySelector(`[data-code="${code}"]`);
          const stock = productCard ? parseInt(productCard.getAttribute('data-stock') || 0) : 999;
          
          const newQty = Math.max(1, qty || 1);
          
          // Validate against actual stock
          if (newQty > stock) {
            showNotification(`Only ${stock} units available for ${item.name}`, 'warning');
            return;
          }
          
          item.qty = newQty;
          cart.set(code, item);
          render();
        }

        function addToCart(el) {
          const name = el.querySelector('.product-name')?.textContent?.trim() || 'Item';
          const price = Number(el.getAttribute('data-price')) || 0;
          const code = el.getAttribute('data-code') || Math.random().toString().slice(2,10);
          const category = (el.getAttribute('data-category') || '').toLowerCase();
          const stock = parseInt(el.getAttribute('data-stock') || 0);
          
          const existing = cart.get(code);
          const currentQty = existing ? existing.qty : 0;
          
          // Check if adding would exceed available stock
          if (currentQty + 1 > stock) {
            showNotification(`Only ${stock} units available for ${name}`, 'warning');
            return;
          }
          
          if (existing) { 
            existing.qty += 1; 
            cart.set(code, existing); 
          } else { 
            cart.set(code, { name, price, qty: 1, category }); 
          }
          render();
        }

        // --- Persistence helpers ---
        function getLocalArray(key) {
          try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; }
        }
        function setLocalArray(key, arr) {
          localStorage.setItem(key, JSON.stringify(arr));
        }

        // Product loading and stock management
        // No default products; use only database products

        function createProductCard(product) {
          const card = document.createElement('article');
          card.className = 'product-card';
          card.setAttribute('data-category', product.category);
          card.setAttribute('data-code', product.code);
          card.setAttribute('data-price', product.price);
          card.setAttribute('data-stock', product.stock || 0);
          
          card.innerHTML = `
            <img src="${product.image_url ? '../' + product.image_url : '../img/rectangle-10.png'}" alt="${product.name}" class="product-image" />
            <h3 class="product-name">${product.name}</h3>
            <p class="product-stock">Stock: ${product.stock || 0}</p>
            <p class="product-price">‚Ç±${Number(product.price || 0).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
          `;
          
          card.addEventListener('click', () => addToCart(card));
          return card;
        }

        function loadProducts() {
          const grid = document.getElementById('productGrid');
          if (!grid) return;

          // Load fresh data from database
          fetch('../api/products.php', { credentials: 'same-origin' })
            .then(res => res.json())
            .then(data => {
              if (data.ok && data.data && data.data.length > 0) {
                // Use API data with database stock values
                grid.innerHTML = '';
                data.data.forEach(product => {
                  const card = createProductCard({
                    ...product,
                    code: (product.barcode && String(product.barcode).trim()) || product.id || Math.random().toString().slice(2, 10)
                  });
                  grid.appendChild(card);
                });
              } else {
                // Empty state
                const grid = document.getElementById('productGrid');
                if (grid) grid.innerHTML = '<div style="color:#a3a3a3; padding:20px">No products found. Add products to see them here.</div>';
              }
              updateStockLevels();
            })
            .catch(() => {
              const grid = document.getElementById('productGrid');
              if (grid) grid.innerHTML = '<div style="color:#a3a3a3; padding:20px">Unable to load products.</div>';
            });
        }

        // removed loadDefaultProducts()

        function updateStockLevels() {
          // This function now simply ensures stock displays are accurate from database
          // No local adjustment - use database values directly
          document.querySelectorAll('.product-card').forEach(card => {
            const stock = parseInt(card.getAttribute('data-stock') || 0);
            const stockP = card.querySelector('.product-stock');
            if (stockP) {
              stockP.textContent = `Stock: ${stock}`;
            }
          });
        }

        // Function to refresh products from database
        async function refreshProductsFromDB() {
          try {
            const res = await fetch('../api/products.php', { credentials: 'same-origin' });
            const data = await res.json();
            if (res.ok && data.ok && data.data && data.data.length > 0) {
              // Update the product grid with fresh data from database
              const grid = document.getElementById('productGrid');
              if (grid) {
                grid.innerHTML = '';
                data.data.forEach(product => {
                  const card = createProductCard({
                    ...product,
                    code: (product.barcode && String(product.barcode).trim()) || product.id || Math.random().toString().slice(2, 10)
                  });
                  grid.appendChild(card);
                });
                updateStockLevels();
                applyCategoryFilter();
                
                // Show success notification
                showNotification('Stock levels refreshed from database', 'success');
              }
            } else {
              showNotification('No products found in database', 'warning');
            }
          } catch (error) {
            console.error('Failed to refresh products from database:', error);
            showNotification('Failed to refresh stock: ' + error.message, 'error');
          }
        }

        // Simple notification system
        function showNotification(message, type = 'info') {
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.textContent = message;
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
          `;
          
          // Set background color based on type
          switch(type) {
            case 'success': notification.style.background = '#059669'; break;
            case 'error': notification.style.background = '#dc2626'; break;
            case 'warning': notification.style.background = '#d97706'; break;
            default: notification.style.background = '#3b82f6';
          }
          
          document.body.appendChild(notification);
          
          // Remove after 3 seconds
          setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
          }, 3000);
        }

        // Operational helpers
        async function getOpenShift() {
          try {
            const res = await fetch('../api/shifts.php?status=open');
            const data = await res.json();
            if (res.ok && data.ok) return data.data || null;
          } catch (_) {}
          return null;
        }
        async function getOpenClock() {
          try {
            const res = await fetch('../api/staff_hours.php?status=open');
            const data = await res.json();
            if (res.ok && data.ok) return data.data || null;
          } catch (_) {}
          return null;
        }
        async function startShift() {
          try {
            const opening = prompt('Enter Opening Cash (‚Ç±):', '0');
            if (opening === null) return;
            const openingCash = parseFloat(opening || '0');
            const res = await fetch('../api/shifts.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify({ opening_cash: isFinite(openingCash) ? openingCash : 0 })
            });
            const data = await res.json();
            if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to start shift');
            const shiftId = data.id;
            // Clock in and tie to shift
            try {
              const fd = new FormData();
              if (shiftId) fd.append('shift_id', String(shiftId));
              const r2 = await fetch('../api/staff_hours.php', { method: 'POST', body: fd, credentials: 'same-origin' });
              const d2 = await r2.json();
              if (!r2.ok || !d2.ok) throw new Error(d2.error || 'Clock-in failed');
              showNotification('Shift started and clocked in successfully', 'success');
            } catch (e) {
              showNotification('Shift started, but clock-in failed: ' + (e?.message || e), 'warning');
            }
          } catch (e) {
            showNotification('Failed to start shift: ' + (e?.message || e), 'error');
          }
        }
        async function endShift() {
          try {
            const open = await getOpenShift();
            if (!open || !open.id) { showNotification('No open shift found', 'warning'); return; }
            // No manual closing cash entry; backend auto-computes based on sales
            const res = await fetch('../api/shifts.php', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify({ id: open.id })
            });
            const data = await res.json();
            if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to end shift');
            // Attempt clock-out
            try {
              const clk = await getOpenClock();
              if (clk && clk.id) {
                const r2 = await fetch('../api/staff_hours.php', { method: 'PATCH', headers: { 'Content-Type':'application/json' }, credentials: 'same-origin', body: JSON.stringify({ id: clk.id }) });
                const d2 = await r2.json();
                if (!r2.ok || !d2.ok) throw new Error(d2.error || 'Clock-out failed');
              }
            } catch (e) {
              // non-fatal
            }
            showNotification(`Shift ended. Close: ‚Ç±${Number(data.closing_cash||0).toFixed(2)}, Sales: ‚Ç±${Number(data.sales_total||0).toFixed(2)}, Var: ‚Ç±${Number(data.variance||0).toFixed(2)}`, 'success');
          } catch (e) {
            showNotification('Failed to end shift: ' + (e?.message || e), 'error');
          }
        }

        // Printer Settings Dialog
        function showPrinterSettings() {
          const currentWidth = localStorage.getItem('pos_receipt_width') || '58mm';
          const storeInfo = JSON.parse(localStorage.getItem('store_info') || '{}');
          
          const dialog = document.createElement('div');
          const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          dialog.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: ${isDark ? 'rgba(0,0,0,0.6)' : 'rgba(0,0,0,0.45)'}; z-index: 9999; display: flex; 
            align-items: center; justify-content: center;
          `;
          
          dialog.innerHTML = `
            <div style="background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 24px; border-radius: 12px; max-width: 500px; width: 90%;">
              <h3 style="margin: 0 0 20px 0; color: var(--text);">üñ®Ô∏è Printer Settings</h3>
              
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Receipt Width:</label>
                <select id="receiptWidth" style="width: 100%; padding: 8px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px;">
                  <option value="58mm" ${currentWidth === '58mm' ? 'selected' : ''}>58mm (XP-58IIH)</option>
                  <option value="80mm" ${currentWidth === '80mm' ? 'selected' : ''}>80mm (Standard)</option>
                </select>
              </div>
              
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Store Name:</label>
                <input type="text" id="storeName" value="${storeInfo.name || "Gelo's Vape Shop"}" 
                       style="width: 100%; padding: 8px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px;">
              </div>
              
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Store Address:</label>
                <input type="text" id="storeAddress" value="${storeInfo.address || ''}" 
                       style="width: 100%; padding: 8px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px;">
              </div>
              
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Store Phone:</label>
                <input type="text" id="storePhone" value="${storeInfo.phone || ''}" 
                       style="width: 100%; padding: 8px; background: var(--bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px;">
              </div>
              
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button id="cancelSettings" style="padding: 8px 16px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px; cursor: pointer;">Cancel</button>
                <button id="saveSettings" style="padding: 8px 16px; border: none; background: #2563eb; color: white; border-radius: 6px; cursor: pointer;">Save Settings</button>
              </div>
              </div>
          `;
          
          document.body.appendChild(dialog);
          
          // Event handlers
          dialog.querySelector('#cancelSettings').onclick = () => dialog.remove();
          dialog.querySelector('#saveSettings').onclick = () => {
            const width = dialog.querySelector('#receiptWidth').value;
            const name = dialog.querySelector('#storeName').value.trim();
            const address = dialog.querySelector('#storeAddress').value.trim();
            const phone = dialog.querySelector('#storePhone').value.trim();
            
            localStorage.setItem('pos_receipt_width', width);
            localStorage.setItem('store_info', JSON.stringify({ name, address, phone }));
            
            // Update receipt CSS width
            updateReceiptWidth(width);
            
            showNotification('Printer settings saved successfully', 'success');
            dialog.remove();
          };
          
          // Close on backdrop click
          dialog.onclick = (e) => { if (e.target === dialog) dialog.remove(); };
        }
        
        // Update receipt width dynamically
        function updateReceiptWidth(width) {
          const style = document.createElement('style');
          style.id = 'dynamic-receipt-width';
          
          // Remove existing dynamic style
          const existing = document.getElementById('dynamic-receipt-width');
          if (existing) existing.remove();
          
          if (width === '80mm') {
            style.textContent = `
              .receipt { width: 80mm !important; max-width: 300px !important; }
              @page { size: 80mm auto !important; }
              .item-row .item-name { flex: 1.5 !important; }
              .item-row .item-qty { width: 40px !important; }
              .item-row .item-price { width: 80px !important; }
              .items-header .col-item { flex: 1.5 !important; }
              .items-header .col-qty { width: 40px !important; }
              .items-header .col-price { width: 80px !important; }
            `;
          }
          
          document.head.appendChild(style);
        }
        
        // Initialize receipt width on page load
        const savedWidth = localStorage.getItem('pos_receipt_width') || '58mm';
        updateReceiptWidth(savedWidth);

        // Test receipt function
        function showTestReceipt() {
          // Get the receipt width setting for the URL parameter
          const receiptWidth = localStorage.getItem('pos_receipt_width') || '58mm';
          
          // Open the receipt.php file with width parameter and autoprint
          const receiptUrl = `../receipt.php?width=${receiptWidth}&autoprint=true&test=true`;
          window.open(receiptUrl, '_blank', 'width=380,height=740');
        }

        async function voidCart() {
          try {
            if (!cart.size) { showNotification('Cart is already empty', 'info'); return; }
            const confirmDiscard = confirm('Void entire cart? This will discard all items and reset totals.');
            if (!confirmDiscard) return;
            cart.clear();
            render();
            showNotification('Cart discarded', 'success');
          } catch (e) {
            showNotification('Failed to void cart: ' + (e?.message || e), 'error');
          }
        }

        async function refundReturn() {
          try {
            const tidStr = prompt('Enter completed Transaction ID to refund (numeric ID from receipt):');
            if (tidStr === null) return;
            const tid = parseInt(tidStr, 10);
            if (!tid || tid <= 0) { showNotification('Invalid transaction ID', 'warning'); return; }

            // Load the original transaction (client-side filter from list)
            let txn = null;
            try {
              const res = await fetch('../api/transactions.php', { credentials: 'same-origin' });
              const data = await res.json();
              if (res.ok && data.ok && Array.isArray(data.data)) {
                txn = data.data.find(t => Number(t.id) === tid);
              }
            } catch (_) {}

            if (!txn) { showNotification('Transaction not found', 'warning'); return; }
            if (txn.status && String(txn.status).toLowerCase() === 'voided') {
              showNotification('Cannot refund a voided transaction', 'warning');
              return;
            }

            const fullRefund = confirm('Refund the entire transaction? Click Cancel to input partial items.');
            let items = [];
            if (fullRefund) {
              items = (txn.items || []).map(it => ({ code: it.code || null, product: it.product, qty: it.qty }));
              if (!items.length) { showNotification('No items found in the transaction', 'warning'); return; }
            } else {
              const help = 'Enter items to refund as code=qty or name=qty, comma-separated.\nExample: 123456789=1, Coil 0.8Œ©=2';
              const inp = prompt(help);
              if (inp === null) return;
              const parts = (inp || '').split(',').map(s => s.trim()).filter(Boolean);
              for (const p of parts) {
                const m = p.match(/^(.+?)[=:]\s*(\d+)$/);
                if (!m) continue;
                const key = m[1].trim();
                const qty = parseInt(m[2], 10);
                if (!isFinite(qty) || qty <= 0) continue;
                const byCode = (txn.items || []).find(it => String(it.code || '') === key);
                if (byCode) { items.push({ code: byCode.code || null, product: byCode.product, qty }); continue; }
                const byName = (txn.items || []).find(it => String(it.product) === key);
                if (byName) { items.push({ code: byName.code || null, product: byName.product, qty }); }
              }
              if (!items.length) { showNotification('No valid items parsed for refund', 'warning'); return; }
            }

            const reason = prompt('Reason for refund/return:');
            if (reason === null || String(reason).trim() === '') { showNotification('Refund reason is required', 'warning'); return; }

            const payload = {
              transaction_id: tid,
              reason: String(reason).trim(),
              items: items.map(it => ({ code: it.code || undefined, product: it.product, qty: it.qty }))
            };

            const res = await fetch('../api/refunds.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify(payload) });
            const data = await res.json();
            if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to process refund');
            showNotification(`Refund processed. Total: ‚Ç±${Number(data.refund_total || 0).toFixed(2)}`, 'success');

            // Refresh product stock to reflect returned items
            try { await refreshProductsFromDB(); } catch (_) {}
          } catch (e) {
            showNotification('Refund failed: ' + (e?.message || e), 'error');
          }
        }

        async function voidTransaction() {
          try {
            const tidStr = prompt('Enter Transaction ID to void (numeric ID from receipt):');
            if (tidStr === null) return;
            const tid = parseInt(tidStr, 10);
            if (!tid || tid <= 0) { showNotification('Invalid transaction ID', 'warning'); return; }
            const reason = prompt('Reason for void/cancel:');
            if (reason === null || String(reason).trim() === '') { showNotification('Void reason is required', 'warning'); return; }
            const res = await fetch('../api/void_transaction.php', { method: 'POST', headers: { 'Content-Type':'application/json' }, credentials: 'same-origin', body: JSON.stringify({ transaction_id: tid, reason: String(reason).trim() }) });
            const data = await res.json();
            if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to void transaction');
            showNotification(`Transaction ${tid} voided`, 'success');
          } catch (e) {
            showNotification('Void failed: ' + (e?.message || e), 'error');
          }
        }

        // Load products on page load
        loadProducts();
        
        // Refresh stock levels when page becomes visible (in case stock was updated in database)
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            loadProducts(); // Reload from database for accurate stock
          }
        });

        async function checkout(paymentMethod) {
          if (!cart.size) { alert('Cart is empty'); return; }
          
          let total = 0; const items = [];
          for (const [code, item] of cart) {
            total += item.price * item.qty;
            items.push({ code, product: item.name, qty: item.qty, price: item.price, category: item.category || '' });
          }
          const nowISO = new Date().toISOString();
          const customerInput = document.getElementById('posCustomer');
          const customerName = (customerInput?.value?.trim()) || 'Walk-in';
          
          // Find customer ID from customer name
          let customerId = null;
          if (customerName !== 'Walk-in') {
            try {
              const res = await fetch('../api/customers.php', { credentials: 'same-origin' });
              const data = await res.json();
              if (res.ok && data.ok) {
                // More flexible matching - trim spaces and case-insensitive
                const searchName = customerName.trim().toLowerCase();
                const customer = data.data.find(c => c.name.trim().toLowerCase() === searchName);
                if (customer) customerId = customer.id;
              }
            } catch (_) {}
          }
          
          const txn = {
            id: 'TXN-' + Date.now(),
            date: nowISO,
            items,
            total,
            paymentMethod,
            cashier: currentUserName,
            customer: customerName,
            customer_id: customerId
          };
          try {
            // Attach current open shift id so sales link to the session
            try {
              const openShift = await getOpenShift();
              if (openShift && openShift.id) txn.shift_id = openShift.id;
            } catch (_) {}
            const res = await fetch('../api/transactions.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify(txn)
            });
            const data = await res.json();
            if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to save transaction');
            
            // Get receipt width setting and open receipt.php with transaction data
            const receiptWidth = localStorage.getItem('pos_receipt_width') || '58mm';
            const receiptTxn = { ...txn, id: data.id || txn.id, ref: data.ref || txn.id };
            
            // Store transaction data temporarily for receipt.php to access
            sessionStorage.setItem('current_receipt_data', JSON.stringify(receiptTxn));
            
            // Open receipt.php with parameters
            const receiptUrl = `../receipt.php?width=${receiptWidth}&autoprint=true&txn_id=${receiptTxn.id}`;
            window.open(receiptUrl, '_blank', 'width=380,height=740');

            // Mirror to localStorage to keep other pages (customers/reports) working
            try {
              const txns = getLocalArray('transactions');
              txns.push(receiptTxn);
              setLocalArray('transactions', txns);

              const movements = getLocalArray('stockMovements');
              items.forEach(it => {
                movements.push({
                  date: txn.date,
                  product: it.product,
                  code: it.code,
                  category: it.category || '',
                  type: 'OUT',
                  qty: it.qty,
                  unitPrice: it.price,
                  paymentMethod
                });
              });
              setLocalArray('stockMovements', movements);
            } catch(_) {}
            cart.clear();
            render();
            alert('Payment successful via ' + paymentMethod + '. Transaction recorded.');
          } catch (e) {
            alert('Server error: ' + (e?.message || e));
          }
        }

        // QZ Tray integration for automatic printing
        let qzReady = false;
        let qzPrinter = null;

        // Initialize QZ Tray connection
        function initQZTray() {
          if (typeof qz === 'undefined') {
            console.log('QZ Tray not available, using browser print fallback');
            return;
          }
          
          qz.websocket.connect().then(() => {
            console.log('QZ Tray connected successfully');
            qzReady = true;
            return qz.printers.find();
          }).then((printers) => {
            // Look for thermal printer (common names)
            const thermalPrinter = printers.find(p => 
              p.toLowerCase().includes('xprinter') || 
              p.toLowerCase().includes('thermal') ||
              p.toLowerCase().includes('receipt') ||
              p.toLowerCase().includes('pos')
            );
            qzPrinter = thermalPrinter || printers[0]; // Use first printer as fallback
            console.log('Selected printer:', qzPrinter);
          }).catch((err) => {
            console.warn('QZ Tray connection failed:', err);
            qzReady = false;
          });
        }

        // Print via QZ Tray (ESC/POS commands for thermal printer)
        function printViaQZTray(txn) {
          if (!qzReady || !qzPrinter) {
            console.log('QZ Tray not ready, falling back to browser print');
            return printReceipt(txn);
          }

          const fmt = (n)=> `‚Ç±${Number(n||0).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
          const d = new Date(txn.date);
          const dateStr = d.toLocaleDateString('en-CA');
          const timeStr = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
          const subtotal = (txn.items||[]).reduce((s,it)=> s + (Number(it.price||0)*Number(it.qty||0)), 0);
          const discount = Number(txn.discount || 0);
          const grand = Math.max(0, subtotal - discount);

          let storeInfo = {};
          try { storeInfo = JSON.parse(localStorage.getItem('store_info')||'{}'); } catch {}
          const storeName = storeInfo.name || "Gelo's Vape Shop";
          const storeAddress = storeInfo.address || '';
          const storePhone = storeInfo.phone || '';

          // ESC/POS commands for thermal printer
          let escpos = '';
          escpos += '\x1B\x40'; // Initialize printer
          escpos += '\x1B\x61\x01'; // Center align
          escpos += storeName + '\n';
          if (storeAddress) escpos += storeAddress + '\n';
          if (storePhone) escpos += storePhone + '\n';
          escpos += '----------------------------------------\n';
          escpos += '\x1B\x61\x00'; // Left align
          escpos += `Date: ${dateStr}     Time: ${timeStr}\n`;
          escpos += `Receipt: #${String(txn.ref||txn.id||'')}\n`;
          escpos += `Cashier: ${txn.cashier || '-'}\n`;
          escpos += '----------------------------------------\n';
          escpos += 'Item                 Qty     Price\n';
          escpos += '----------------------------------------\n';
          
          (txn.items||[]).forEach(it => {
            const name = (it.product || '').substring(0, 20).padEnd(20);
            const qty = String(Number(it.qty||0)).padStart(3);
            const price = fmt((Number(it.qty)||0)*(Number(it.price)||0)).padStart(8);
            escpos += `${name} ${qty} ${price}\n`;
          });
          
          escpos += '========================================\n';
          escpos += `Subtotal:                    ${fmt(subtotal)}\n`;
          if (discount > 0) escpos += `Discount:                   -${fmt(discount)}\n`;
          escpos += `TOTAL:                       ${fmt(grand)}\n`;
          escpos += '----------------------------------------\n';
          escpos += '\x1B\x61\x01'; // Center align
          escpos += `Payment: ${txn.paymentMethod}\n`;
          escpos += '----------------------------------------\n';
          escpos += 'Thank you for shopping!\n';
          escpos += 'Come back soon!\n\n\n';
          escpos += '\x1D\x56\x41'; // Cut paper

          const config = qz.configs.create(qzPrinter);
          const data = [{
            type: 'raw',
            format: 'plain',
            data: escpos
          }];

          qz.print(config, data).then(() => {
            console.log('Receipt printed successfully via QZ Tray');
          }).catch((err) => {
            console.error('QZ Tray print failed:', err);
            // Fallback to browser print
            printReceipt(txn);
          });
        }

        function printReceipt(txn, win){
          const fmt = (n)=> `‚Ç±${Number(n||0).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
          const d = new Date(txn.date);
          const dateStr = d.toLocaleDateString('en-CA');
          const timeStr = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
          const subtotal = (txn.items||[]).reduce((s,it)=> s + (Number(it.price||0)*Number(it.qty||0)), 0);
          const discount = Number(txn.discount || 0);
          const grand = Math.max(0, subtotal - discount);
          const rows = (txn.items||[]).map(it => `
            <div class="item-row">
              <span class="item-name">${it.product}</span>
              <span class="item-qty">${Number(it.qty||0)}</span>
              <span class="item-price">${fmt((Number(it.qty)||0)*(Number(it.price)||0))}</span>
            </div>
          `).join('');

          // Resolve absolute logo URL so it loads in about:blank
          const baseUrl = new URL('../', window.location.href).href; // e.g., http://localhost:8081/
          const logoUrl = baseUrl + 'gelo.png';
          // Optional: store info from localStorage (customizable via Settings page in future)
          let storeInfo = {};
          try { storeInfo = JSON.parse(localStorage.getItem('store_info')||'{}'); } catch {}
          const storeName = storeInfo.name || "Gelo's Vape Shop";
          const storeAddress = storeInfo.address || '';
          const storePhone = storeInfo.phone || '';
          const storeEmail = storeInfo.email || '';

          // Respect saved receipt width in the about:blank print window
          const receiptWidth = localStorage.getItem('pos_receipt_width') || '58mm';
          const widthCss = receiptWidth === '80mm'
            ? `
                .receipt { width: 80mm; max-width: 300px; }
                @page { size: 80mm auto; }
                .item-row .item-name { flex: 1.5; }
                .item-row .item-qty { width: 40px; }
                .item-row .item-price { width: 80px; }
                .items-header .col-item { flex: 1.5; }
                .items-header .col-qty { width: 40px; }
                .items-header .col-price { width: 80px; }
              `
            : `
                .receipt { width: 58mm; max-width: 220px; }
                @page { size: 58mm auto; }
              `;

          win = win || window.open('', '_blank', 'width=380,height=740,noopener');
          if (!win) return;
          // Explicitly open the document to avoid blank content in certain browsers
          try { win.document.open(); } catch {}
          win.document.write(`
            <html>
            <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <title>Receipt ${String(txn.id||'')}</title>
              <base href="${baseUrl}" />
              <style>
                *{ box-sizing:border-box }
                body{ margin:0; background:#fff; color:#000; font: 11px/1.3 'Courier New', Courier, monospace; }
                .receipt{ margin:0 auto; padding:4mm 2mm; }
                .header{ text-align:center; margin-bottom:8px; }
                .header .logo{ display:block; width:40px; height:auto; margin:0 auto 3px; }
                .header .store{ font-weight:700; font-size:13px; margin-bottom:2px; }
                .header .details{ font-size:10px; line-height:1.2; white-space:pre-line; }
                .separator{ border-top:1px dashed #000; margin:6px 0; }
                .separator-double{ border-top:2px solid #000; margin:6px 0; }
                .meta{ font-size:10px; margin:6px 0; }
                .meta .line{ display:flex; justify-content:space-between; margin-bottom:1px; }
                .items-header{ display:flex; font-weight:700; font-size:10px; margin-bottom:3px; }
                .items-header .col-item{ flex:1; }
                .items-header .col-qty{ width:30px; text-align:center; }
                .items-header .col-price{ width:60px; text-align:right; }
                .item-row{ display:flex; font-size:10px; margin-bottom:2px; }
                .item-row .item-name{ flex:1; }
                .item-row .item-qty{ width:30px; text-align:center; }
                .item-row .item-price{ width:60px; text-align:right; }
                .totals{ margin-top:6px; font-size:10px; }
                .totals .row{ display:flex; justify-content:space-between; padding:1px 0; }
                .totals .grand{ font-weight:700; font-size:12px; margin-top:3px; }
                .payment-info{ margin:6px 0; font-size:10px; text-align:center; }
                .footer{ text-align:center; margin-top:8px; font-size:10px; }
                .print-actions{ display:flex; gap:8px; margin-top:10px; }
                .btn{ flex:1; border:1px solid #000; background:#fff; padding:6px 8px; cursor:pointer; font-size:11px; }
                @page { margin: 2mm; }
                ${widthCss}
                @media print{ 
                  .print-actions{ display:none !important; }
                  body{ font-size:10px; }
                  .receipt{ padding:2mm 1mm; }
                }
              </style>
            </head>
            <body>
              <div class="receipt">
                <div class="header">
                  <img class="logo" src="${logoUrl}" alt="Logo" />
                  <div class="store">${storeName}</div>
                  <div class="details">${[storeAddress, storePhone, storeEmail].filter(Boolean).join('\n')}</div>
                </div>
                
                <div class="separator"></div>
                
                <div class="meta">
                  <div class="line"><span>Date:</span><span>${dateStr}</span></div>
                  <div class="line"><span>Time:</span><span>${timeStr}</span></div>
                  <div class="line"><span>Receipt:</span><span>#${String(txn.ref||txn.id||'')}</span></div>
                  <div class="line"><span>Cashier:</span><span>${txn.cashier || '-'}</span></div>
                </div>
                
                <div class="separator"></div>
                
                <div class="items-header">
                  <span class="col-item">Item</span>
                  <span class="col-qty">Qty</span>
                  <span class="col-price">Price</span>
                </div>
                
                <div class="separator"></div>
                
                <div class="items">
                  ${rows}
                </div>
                
                <div class="separator-double"></div>
                
                <div class="totals">
                  <div class="row"><span>Subtotal:</span><span>${fmt(subtotal)}</span></div>
                  ${discount ? `<div class="row"><span>Discount:</span><span>-${fmt(discount)}</span></div>` : ''}
                  <div class="row grand"><span>TOTAL:</span><span>${fmt(grand)}</span></div>
                </div>
                
                <div class="separator"></div>
                
                <div class="payment-info">
                  Payment: ${txn.paymentMethod}
                </div>
                
                <div class="separator"></div>
                
                <div class="footer">
                  Thank you for shopping!<br>
                  Come back soon!
                </div>
                
                <div class="print-actions">
                  <button class="btn" onclick="window.close()">Close</button>
                  <button class="btn" onclick="window.print()">Print Receipt</button>
                </div>
              </div>
            </body>
            </html>
          `);
          win.document.close();
          // Trigger print when the new window finishes loading
          try {
            win.addEventListener('load', () => { try { win.focus(); win.print(); } catch {} });
          } catch {
            // Fallback in case 'load' listener isn't available
            setTimeout(() => { try { win.focus(); win.print(); } catch {} }, 300);
          }
        }

        // Product cards are now created dynamically with event listeners

        // Category filter (like inventory)
        const categorySelect = document.getElementById('categoryFilter');
        function applyCategoryFilter() {
          const value = categorySelect ? categorySelect.value : 'all';
          document.querySelectorAll('.product-card').forEach(card => {
            const cat = (card.getAttribute('data-category') || '').toLowerCase();
            card.style.display = (value === 'all' || cat === value || cat.includes(value)) ? '' : 'none';
          });
        }
        if (categorySelect) categorySelect.addEventListener('change', applyCategoryFilter);
        
        // Apply filter after products are loaded
        function applyFilterAfterLoad() {
          setTimeout(applyCategoryFilter, 100);
        }
        window.addEventListener('load', applyFilterAfterLoad);

        // Load customers for suggestions (API with local fallback)
        (async function loadCustomerSuggestions(){
          const dl = document.getElementById('posCustomerList');
          let list = [];
          try {
            const res = await fetch('../api/customers.php', { credentials: 'same-origin' });
            const data = await res.json();
            if (res.ok && data.ok) list = data.data || [];
          } catch (_) {
            try { list = JSON.parse(localStorage.getItem('customers')||'[]'); } catch {}
          }
          if (dl) dl.innerHTML = (list||[]).map(c=>`<option value="${c.name}">${c.phone ? ' ‚Ä¢ '+c.phone : ''}</option>`).join('');
        })();

        // Pay buttons
        const cashBtn = document.querySelector('.pay-btn.cash');
        const gcashBtn = document.querySelector('.pay-btn.gcash');
        if (cashBtn) cashBtn.addEventListener('click', () => checkout('Cash'));
        if (gcashBtn) gcashBtn.addEventListener('click', () => checkout('GCash'));

        // Refresh stock button
        const refreshStockBtn = document.getElementById('refreshStockBtn');
        if (refreshStockBtn) {
          refreshStockBtn.addEventListener('click', refreshProductsFromDB);
        }

        // Operational control buttons ‚Äî simple alert handlers
        const startShiftBtnEl = document.getElementById('startShiftBtn');
        if (startShiftBtnEl) startShiftBtnEl.addEventListener('click', startShift);
        const endShiftBtnEl = document.getElementById('endShiftBtn');
        if (endShiftBtnEl) endShiftBtnEl.addEventListener('click', endShift);

        const voidCartBtnEl = document.getElementById('voidCartBtn');
        if (voidCartBtnEl) voidCartBtnEl.addEventListener('click', voidCart);
        const refundBtnEl = document.getElementById('refundBtn');
        if (refundBtnEl) refundBtnEl.addEventListener('click', refundReturn);
        
        // Printer settings button
        const printerSettingsBtnEl = document.getElementById('printerSettingsBtn');
        if (printerSettingsBtnEl) printerSettingsBtnEl.addEventListener('click', showPrinterSettings);
        
        // Test receipt button
        const testReceiptBtnEl = document.getElementById('testReceiptBtn');
        if (testReceiptBtnEl) testReceiptBtnEl.addEventListener('click', showTestReceipt);

        // Barcode scanner integration
        const searchInputEl = document.getElementById('productSearch') || document.querySelector('.search-bar input[type="search"]');
        const scannerToggleEl = document.querySelector('.barcode-toggle input');
        let scannerEnabled = false;
        let scanBuffer = '';
        let scanTimer = null;
        
        function finalizeScan() {
          const code = (scanBuffer || '').trim();
          if (!code) return;
          if (searchInputEl) searchInputEl.value = code;
          // Safely build selector for attribute equals
          const safe = code.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
          const card = document.querySelector(`.product-card[data-code="${safe}"]`);
          if (card) {
            addToCart(card);
            // Auto-clear for next scan
            if (searchInputEl) searchInputEl.value = '';
            showNotification('Item added', 'success');
          } else {
            showNotification('No product found for code: ' + code, 'warning');
          }
          scanBuffer = '';
        }
        
        function handleKeydown(e) {
          if (!scannerEnabled) return;
          const tgt = e.target;
          const isEditable = tgt && (tgt.isContentEditable || (tgt.tagName === 'INPUT' && tgt.type !== 'search') || tgt.tagName === 'TEXTAREA');
          if (isEditable) return; // don't interfere with other inputs (qty, customer, etc.)
        
          if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(scanTimer);
            finalizeScan();
            return;
          }
          if (e.key && e.key.length === 1) {
            scanBuffer += e.key;
            clearTimeout(scanTimer);
            // Short delay to consider scan finished if no more keys arrive
            scanTimer = setTimeout(finalizeScan, 100);
          }
        }
        
        function enableScanner(on) {
          scannerEnabled = !!on;
          if (scannerEnabled) {
            document.addEventListener('keydown', handleKeydown);
            if (searchInputEl) searchInputEl.focus();
          } else {
            document.removeEventListener('keydown', handleKeydown);
            scanBuffer = '';
            if (searchInputEl) searchInputEl.value = '';
          }
        }
        
        if (scannerToggleEl) {
          scannerToggleEl.addEventListener('change', (e) => enableScanner(e.target.checked));
        }
        
        if (searchInputEl) {
          // Support Enter in the search field while scanner is enabled
          searchInputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && scannerEnabled) {
              e.preventDefault();
              scanBuffer = searchInputEl.value || '';
              finalizeScan();
            }
          });
        }

        render();
        
      })();
    </script>
  </body>
</html>
