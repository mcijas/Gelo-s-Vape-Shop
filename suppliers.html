<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title>Suppliers</title>
    <link rel="stylesheet" href="global.css" />
    <link rel="stylesheet" href="product_list.css" />
    <style>
      .main-content { padding-top: 16px; }
      .toolbar-actions { margin-left: auto; display: flex; gap: 8px; }
      .status-badge { display: inline-flex; align-items: center; padding: 2px 10px; border-radius: 999px; font-size: 12px; border: 1px solid #2a2a2a; background: #1f2223; color: #bdbdbd; }
      .status-badge.active { background: #0f2a14; color: #9ff6b2; border-color: #214d2c; }
      /* Move plus icon to the right of label for suppliers add button */
      .add-supplier-btn .add::before { margin-right: 0; margin-left: 8px; }
      table { table-layout: fixed; }
      thead th, tbody td { vertical-align: middle; }
      /* Column sizing */
      thead th:nth-child(1), tbody td:nth-child(1) { width: 260px; }
      thead th:nth-child(2), tbody td:nth-child(2) { width: 260px; }
      thead th:nth-child(3), tbody td:nth-child(3) { width: 160px; }
      thead th:nth-child(4), tbody td:nth-child(4) { width: 140px; }
      thead th:nth-child(5), tbody td:nth-child(5) { width: 120px; text-align: center; }
      thead th:nth-child(6), tbody td:nth-child(6) { width: 120px; text-align: center; }
      
      /* Category tags styling */
      .category-tags { display: flex; flex-wrap: wrap; gap: 4px; }
      .category-tag { 
        background: #1e40af; 
        color: #ffffff; 
        padding: 2px 8px; 
        border-radius: 12px; 
        font-size: 11px; 
        font-weight: 500;
        border: 1px solid #3b82f6;
      }
      
      /* Modal styling */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      
      .modal-content {
        background: #1f2223;
        border: 1px solid #404040;
        border-radius: 12px;
        padding: 24px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #404040;
      }
      
      .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #f5f5f5;
      }
      
      .close-btn {
        background: none;
        border: none;
        color: #a3a3a3;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .close-btn:hover {
        color: #f5f5f5;
      }
      
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-group label {
        display: block;
        color: #d4d4d4;
        font-size: 14px;
        margin-bottom: 6px;
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        height: 40px;
        background: #1f2223;
        border: 1px solid #404040;
        border-radius: 6px;
        color: #f5f5f5;
        padding: 0 12px;
        font-size: 14px;
      }
      
      .form-group textarea {
        height: 80px;
        resize: vertical;
        padding: 12px;
      }
      
      .category-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
      }
      
      .category-checkbox {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      .category-checkbox input[type="checkbox"] {
        width: auto;
        height: auto;
      }
      
      .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid #404040;
      }
      
      .btn {
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        font-size: 14px;
      }
      
      .btn-primary {
        background: #059669;
        color: #ffffff;
      }
      
      .btn-secondary {
        background: #404040;
        color: #f5f5f5;
      }
      
      .btn-danger {
        background: #dc2626;
        color: #ffffff;
      }
      
      .supplier-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .stat-card {
        background: #2a2a2a;
        padding: 16px;
        border-radius: 8px;
        text-align: center;
      }
      
      .stat-value {
        font-size: 24px;
        font-weight: 600;
        color: #4ade80;
        margin-bottom: 4px;
      }
      
      .stat-label {
        font-size: 12px;
        color: #a3a3a3;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      /* Archive button styling */
      #openArchiveBtn {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 56px;
        height: 56px;
        background: #dc2626;
        color: #ffffff;
        border: none;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        transition: all 0.3s ease;
        z-index: 100;
      }
      
      #openArchiveBtn:hover {
        background: #b91c1c;
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
      }
      
      /* Archive modal styling */
      .archive-tabs {
        display: flex;
        border-bottom: 1px solid #404040;
        margin-bottom: 20px;
      }
      
      .archive-tab {
        flex: 1;
        padding: 12px 16px;
        background: none;
        border: none;
        color: #a3a3a3;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
      }
      
      .archive-tab.active {
        color: #4ade80;
        border-bottom-color: #4ade80;
      }
      
      .archive-tab:hover {
        color: #f5f5f5;
      }
      
      .archive-content {
        display: none;
      }
      
      .archive-content.active {
        display: block;
      }
      
      .archive-item {
        background: #2a2a2a;
        border: 1px solid #404040;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
      }
      
      .archive-item:hover {
        border-color: #525252;
        background: #323232;
      }
      
      .restored-item {
        background: #0f2a14;
        border-color: #214d2c;
      }
      
      .archive-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      
      .archive-item-name {
        font-weight: 600;
        color: #f5f5f5;
        font-size: 16px;
      }
      
      .archive-item-date {
        font-size: 12px;
        color: #a3a3a3;
      }
      
      /* Log Delivery modal: large layout */
      #logDeliveryModal { overflow-y: auto; padding: 24px; }
      #logDeliveryModal .modal-content {
        width: 80vw; max-width: 80vw; height: 80vh; max-height: 80vh;
        overflow: visible; display: flex; flex-direction: column;
      }
      #logDeliveryModal .form-row.two-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      #ldProductsSection { flex: 1 1 auto; display: flex; flex-direction: column; }
      #ldProductTable { flex: 1 1 auto; }
      @media (max-width: 900px) {
        #logDeliveryModal .modal-content { width: 95vw; height: 90vh; }
        #logDeliveryModal .form-row.two-cols { grid-template-columns: 1fr; }
      }
      .archive-item-categories {
        margin-bottom: 12px;
      }
      
      .archive-item-actions {
        display: flex;
        gap: 8px;
      }
      
      .restore-btn {
        background: #059669;
        color: #ffffff;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.3s ease;
      }
      
      .restore-btn:hover {
        background: #047857;
      }
      
      .permanent-delete-btn {
        background: #dc2626;
        color: #ffffff;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.3s ease;
      }
      
      .permanent-delete-btn:hover {
        background: #b91c1c;
      }
      
      #emptyArchiveBtn {
        background: #dc2626;
        color: #ffffff;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        margin-top: 16px;
        transition: background 0.3s ease;
      }
      
      #emptyArchiveBtn:hover {
        background: #b91c1c;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <aside class="sidebar">
        <div class="sidebar-top">
          <div class="brand"><img src="gelo.png" alt="Gelo's Vape Shop logo" /></div>
          <nav class="nav">
            <ul class="nav-list">
              <li><a href="Pages/dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
              <li class="has-submenu">
                <a href="Pages/inventory.html"><span class="icon">üì¶</span><span class="label">Inventory</span></a>
                <ul class="submenu">
                  <li><a href="product_list.html">Product List</a></li>
                </ul>
              </li>
              <li><a href="Pages/pos.html"><span class="icon">üßæ</span><span class="label">POS</span></a></li>
              <li><a href="customers.html"><span class="icon">üë•</span><span class="label">Customer</span></a></li>
              <li><a class="active" href="suppliers.html"><span class="icon">üöö</span><span class="label">Suppliers</span></a></li>
              <li class="has-submenu">
                <a href="reports.html"><span class="icon">üìä</span><span class="label">Reports</span></a>
                <ul class="submenu">
                  <li><a href="reports.html#sales-reports">Sales Reports</a></li>
                  <li><a href="reports.html#inventory-reports">Inventory Reports</a></li>
                  <li><a href="reports.html#financial-reports">Financial Reports</a></li>
                  <li><a href="reports.html#supplier-reports">Supplier Reports</a></li>
                  <li><a href="reports.html#customer-reports">Customer Reports</a></li>
                  <li><a href="reports.html#operational-reports">Operational Reports</a></li>
                </ul>
              </li>
              <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
            </ul>
          </nav>
        </div>
        <a href="index.html" class="logout"><span class="icon">‚éã</span><span class="label">Logout</span></a>
      </aside>

      <main class="main-content">
        <div class="toolbar">
          <div class="search-bar">
            <input type="search" placeholder="Search suppliers..." aria-label="Search suppliers" id="supplierSearch" />
            <button type="button" aria-label="Search"><span class="icon search"></span></button>
          </div>
          <div class="category-select">
            <select id="supplierCategory" aria-label="Filter by category">
              <option value="all">All Categories</option>
              <option value="Units">Units</option>
              <option value="Disposable">Disposable</option>
              <option value="E-juice">E-juice</option>
              <option value="Hardware">Hardware</option>
            </select>
          </div>
          <div class="toolbar-actions">
            <button class="add-product-btn" id="logDeliveryBtn">Log Delivery</button>
            <button class="add-product-btn add-supplier-btn" id="addSupplierBtn">Add Supplier<span class="icon add" aria-hidden="true"></span></button>
          </div>
        </div>

        <section class="table-card">
          <table id="suppliersTable">
            <thead>
              <tr>
                <th>Supplier Name</th>
                <th>Contact</th>
                <th>Categories</th>
                <th>Last Order</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="pagination">
            <button class="page-btn">Previous</button>
            <button class="page-btn active">1</button>
            <button class="page-btn">2</button>
            <button class="page-btn">3</button>
            <button class="page-btn">Next</button>
          </div>
        </section>
      </main>
    </div>

    <!-- Log Delivery Modal -->
    <div class="modal-overlay" id="logDeliveryModal" style="display:none">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Log Delivery</h3>
          <button class="close-btn" onclick="closeModal('logDeliveryModal')">&times;</button>
        </div>

        <div class="form-row two-cols">
          <div class="form-group">
            <label>Supplier</label>
            <select id="ldSupplier"></select>
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="ldDate" />
          </div>
        </div>

        <div class="form-group" id="ldProductsSection">
          <label>Products</label>
          <div>
            <table id="ldProductTable" style="width:100%; border-collapse:collapse; background:#1f1f1f; border-radius:6px; overflow:hidden;">
              <thead>
                <tr style="background:#2a2a2a; text-align:left;">
                  <th style="padding:8px; font-weight:600;">Product Name</th>
                  <th style="padding:8px; font-weight:600; width:160px;">Barcode</th>
                  <th style="padding:8px; font-weight:600; width:160px;">Category</th>
                  <th style="padding:8px; font-weight:600; width:120px;">Quantity</th>
                  <th style="padding:8px; font-weight:600; width:140px;">Unit Cost (‚Ç±)</th>
                  <th style="padding:8px; font-weight:600; width:110px;">Action</th>
                </tr>
              </thead>
              <tbody id="ldProductsBody"></tbody>
            </table>
            <button type="button" class="btn btn-secondary" id="ldAddProductBtn" style="margin-top:10px;">+ Add Product</button>
            <div id="ldSummary" style="margin-top:10px; color:#a3a3a3; font-size:14px;">Total items: <span id="ldTotalItems">0</span> ‚Ä¢ Total cost: ‚Ç±<span id="ldTotalCost">0.00</span></div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('logDeliveryModal')">Cancel</button>
          <button class="btn btn-primary" onclick="saveDelivery()">Save</button>
        </div>
      </div>
    </div>

    <!-- Floating Archive Button -->
    <button id="openArchiveBtn" onclick="openModal('archiveModal')" title="Open Archive">üóëÔ∏è</button>

    <!-- Supplier Details Modal -->
    <div class="modal-overlay" id="supplierDetailsModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Supplier Details</h3>
          <button class="close-btn" onclick="closeModal('supplierDetailsModal')">&times;</button>
        </div>
        
        <div class="supplier-stats">
          <div class="stat-card">
            <div class="stat-value" id="totalProducts">24</div>
            <div class="stat-label">Total Products</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalOrders">156</div>
            <div class="stat-label">Total Orders</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalSpent">‚Ç±45,230</div>
            <div class="stat-label">Total Spent</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgOrderValue">‚Ç±290</div>
            <div class="stat-label">Avg Order Value</div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Supplier Name</label>
          <input type="text" id="detailSupplierName" readonly>
        </div>
        
        <div class="form-group">
          <label>Contact Information</label>
          <input type="email" id="detailContact" readonly>
        </div>
        
        <div class="form-group">
          <label>Categories Supplied</label>
          <div id="detailCategories" class="category-tags"></div>
        </div>
        
        <div class="form-group">
          <label>Products by Category</label>
          <div id="productsByCategory">
            <div style="background: #2a2a2a; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
              <h4 style="color: #4ade80; margin: 0 0 8px 0;">E-Liquids (12 products)</h4>
              <div style="font-size: 12px; color: #a3a3a3;">Nicotine Salts, Freebase, Disposables</div>
            </div>
            <div style="background: #2a2a2a; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
              <h4 style="color: #60a5fa; margin: 0 0 8px 0;">Devices (12 products)</h4>
              <div style="font-size: 12px; color: #a3a3a3;">Mods, Pods, Tanks, Coils</div>
            </div>
          </div>
        </div>
        
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeModal('supplierDetailsModal')">Close</button>
          <button class="btn btn-primary" onclick="editSupplier()">Edit Supplier</button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Supplier Modal -->
    <div class="modal-overlay" id="supplierModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modalTitle">Add New Supplier</h3>
          <button class="close-btn" onclick="closeModal('supplierModal')">&times;</button>
        </div>
        
        <form id="supplierForm">
          <div class="form-group">
            <label>Supplier Name *</label>
            <input type="text" id="supplierName" required>
          </div>
          
          <div class="form-group">
            <label>Contact Email *</label>
            <input type="email" id="supplierEmail" required>
          </div>
          
          <div class="form-group">
            <label>Phone Number</label>
            <input type="tel" id="supplierPhone">
          </div>
          
          <div class="form-group">
            <label>Address</label>
            <textarea id="supplierAddress"></textarea>
          </div>
          
          <div class="form-group">
             <label>Categories Supplied *</label>
            <div class="category-checkboxes">
              <label class="category-checkbox">
                <input type="checkbox" value="Units"> Units
              </label>
              <label class="category-checkbox">
                <input type="checkbox" value="Disposable"> Disposable
              </label>
              <label class="category-checkbox">
                <input type="checkbox" value="E-juice"> E-juice
              </label>
              <label class="category-checkbox">
                <input type="checkbox" value="Hardware"> Hardware
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label>Notes</label>
            <textarea id="supplierNotes" placeholder="Additional notes about this supplier..."></textarea>
          </div>
        </form>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal('supplierModal')">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveSupplier()">Save Supplier</button>
        </div>
      </div>
    </div>

    <!-- Archive Modal -->
    <div class="modal-overlay" id="archiveModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Archive</h3>
          <button class="close-btn" onclick="closeModal('archiveModal')">&times;</button>
        </div>
        <div class="archive-tabs">
          <button class="archive-tab active" onclick="openArchiveTab('active')">Active Suppliers</button>
          <button class="archive-tab" onclick="openArchiveTab('deleted')">Deleted Suppliers</button>
        </div>
        <div class="archive-content active" id="activeArchiveContent">
          <div id="activeSuppliersContent">
            <!-- Active suppliers will be populated dynamically -->
          </div>
        </div>
        <div class="archive-content" id="deletedArchiveContent">
          <!-- No deleted suppliers -->
          <p style="text-align: center; color: #a3a3a3; margin: 40px 0;">No deleted suppliers found.</p>
          <button id="emptyArchiveBtn" onclick="emptyArchive()" style="display: block; margin: 20px auto; padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;">Empty Archive</button>
        </div>
      </div>
    </div>

    <script src="global.js"></script>
    <script>
      // Suppliers data will be loaded from the database
      let suppliers = [];

      let currentSupplierId = null;
      // archivedSuppliers is no longer needed as we use the database

             // Global variables
       let rows = [];
       
       // Product caches for Log Delivery autocomplete
       let allProducts = [];
       let productsByName = new Map();
       let productsByBarcode = new Map();
       let supplierProductNames = new Map(); // supplier => Set(productName)
       let lastUnitCostBySupplierProduct = new Map(); // `${supplier}||${product}` => unitCost
       let lastCategoryBySupplierProduct = new Map(); // `${supplier}||${product}` => category
       let productsLoaded = false;

       async function ensureProductCaches() {
         if (productsLoaded) return;
         try {
           const [pRes, mRes] = await Promise.all([
             fetch('api/products.php', { credentials: 'same-origin' }),
             fetch('api/stock_movements.php', { credentials: 'same-origin' })
           ]);
           const [pData, mData] = await Promise.all([
             pRes.json().catch(() => ({})),
             mRes.json().catch(() => ({}))
           ]);
           allProducts = (pRes.ok && pData.ok && Array.isArray(pData.data)) ? pData.data : [];
           productsByName.clear();
           productsByBarcode.clear();
           allProducts.forEach(prod => {
             const nameKey = (prod.name || '').toLowerCase();
             if (nameKey) productsByName.set(nameKey, prod);
             if (prod.barcode) productsByBarcode.set(String(prod.barcode), prod);
           });
           supplierProductNames.clear();
           lastUnitCostBySupplierProduct.clear();
           lastCategoryBySupplierProduct.clear();
           const moves = (mRes.ok && mData.ok && Array.isArray(mData.data)) ? mData.data : [];
           // Process most recent first so the first set is the latest
           for (const mv of moves) {
             if ((mv.type || '') !== 'IN') continue;
             const sup = (mv.supplier || '').trim();
             const prod = (mv.product || '').trim();
             if (!sup || !prod) continue;
             if (!supplierProductNames.has(sup)) supplierProductNames.set(sup, new Set());
             supplierProductNames.get(sup).add(prod);
             const key = sup + '||' + prod;
             if (!lastUnitCostBySupplierProduct.has(key) && mv.unitCost != null) {
               lastUnitCostBySupplierProduct.set(key, Number(mv.unitCost) || 0);
             }
             if (!lastCategoryBySupplierProduct.has(key) && mv.category) {
               lastCategoryBySupplierProduct.set(key, mv.category);
             }
           }
           productsLoaded = true;
         } catch (_) {
           // If fetching fails, keep caches empty and allow manual entry
           productsLoaded = true;
         }
       }

       function getProductsForSupplier(supName) {
         const set = supName && supplierProductNames.get(supName);
         if (set && set.size) {
           const names = Array.from(set);
           return names.map(n => productsByName.get(n.toLowerCase()) || { name: n }).filter(Boolean);
         }
         // If supplier has no prior deliveries, don't show unrelated products; allow manual entry
         return [];
       }

       function autofillFromProduct(prod, catSel, costEl, barcodeEl) {
         try {
           if (barcodeEl) barcodeEl.value = prod.barcode ? String(prod.barcode) : '';
           const sup = document.getElementById('ldSupplier')?.value || '';
           const key = sup + '||' + (prod.name || '');
           const lastCat = lastCategoryBySupplierProduct.get(key) || prod.category || '';
           if (catSel && lastCat) {
             const opt = Array.from(catSel.options).find(o => o.value.toLowerCase() === String(lastCat).toLowerCase());
             if (opt) catSel.value = opt.value;
           }
           const lastPrice = lastUnitCostBySupplierProduct.get(key);
           const fallback = (prod.price != null) ? Number(prod.price) : 0;
           if (costEl && (lastPrice != null || fallback)) {
             const val = (lastPrice != null ? lastPrice : fallback) || 0;
             costEl.value = String(Number(val).toFixed(2));
           }
         } catch (_) {}
       }

       function attachNameAutocomplete(nameEl, barcodeEl, catSel, costEl) {
         if (!nameEl) return () => {};
         const listId = 'dl_' + Math.random().toString(36).slice(2);
         const dl = document.createElement('datalist');
         dl.id = listId;
         document.body.appendChild(dl);
         nameEl.setAttribute('list', listId);
         const updateList = () => {
           const sup = document.getElementById('ldSupplier')?.value || '';
           const q = (nameEl.value || '').toLowerCase();
           const candidates = getProductsForSupplier(sup);
           const filtered = q ? candidates.filter(p => (p.name || '').toLowerCase().includes(q)) : candidates;
           dl.innerHTML = filtered.slice(0, 50).map(p => `<option value="${(p.name || '').replace(/\"/g,'&quot;')}"></option>`).join('');
         };
         nameEl.addEventListener('input', updateList);
         nameEl.addEventListener('focus', updateList);
         nameEl.addEventListener('change', () => {
           const val = (nameEl.value || '').trim();
           if (!val) return;
           const prod = productsByName.get(val.toLowerCase());
           if (prod) {
             autofillFromProduct(prod, catSel, costEl, barcodeEl);
           }
           updateDeliverySummary();
         });
         // initialize list
         updateList();
         return () => { try { document.body.removeChild(dl); } catch(_){} };
       }

       function attachBarcodeAutoFill(barcodeEl, nameEl, catSel, costEl) {
         if (!barcodeEl) return;
         barcodeEl.addEventListener('input', () => {
           const code = (barcodeEl.value || '').trim();
           if (!code) return;
           const prod = productsByBarcode.get(code);
           if (prod) {
             if (nameEl) nameEl.value = prod.name || '';
             autofillFromProduct(prod, catSel, costEl, barcodeEl);
             updateDeliverySummary();
           }
         });
       }

       // Remove any legacy localStorage-backed suppliers data to ensure DB is the source of truth
       try { localStorage.removeItem('suppliers'); localStorage.removeItem('archivedSuppliers'); } catch {}

       function applyFilters() {
         const select = document.getElementById('supplierCategory');
         const search = document.getElementById('supplierSearch');
         const category = (select && select.value) || 'all';
         const query = ((search && search.value) || '').toLowerCase();
         rows.forEach(r => {
           const categories = r.getAttribute('data-categories') || '';
           const text = r.textContent.toLowerCase();
           const matchCat = (category === 'all' || categories.includes(category));
           const matchText = (!query || text.includes(query));
           r.style.display = (matchCat && matchText) ? '' : 'none';
         });
       }

       // Global function to load suppliers
       async function loadSuppliers(){
         const tbody = document.querySelector('#suppliersTable tbody');
         if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="color:#a3a3a3; padding:12px">Loading suppliers...</td></tr>';
         try {
           const res = await fetch('api/suppliers.php');
           const data = await res.json();
           suppliers = (res.ok && data.ok) ? (data.data||[]) : [];
           if (!tbody) return;
           if (!suppliers.length) { tbody.innerHTML = '<tr><td colspan="6" style="color:#a3a3a3; padding:12px">No suppliers yet.</td></tr>'; rows = []; return; }
           tbody.innerHTML = suppliers.map(s=>{
             const cats = (Array.isArray(s.categories)?s.categories:[]).join(',');
             const tags = (Array.isArray(s.categories)?s.categories:[]).map(cat=>`<span class="category-tag">${cat}</span>`).join('');
             const lod = s.last_order_date ? (String(s.last_order_date).includes('T') ? String(s.last_order_date).split('T')[0] : String(s.last_order_date).split(' ')[0]) : '‚Äî';
             return `
               <tr data-id="${s.id}" data-categories="${cats}">
                 <td>${s.name}</td>
                 <td>${s.email||''}</td>
                 <td><div class="category-tags">${tags}</div></td>
                 <td>${lod}</td>
                 <td><span class="status-badge active">Active</span></td>
                 <td class="actions">
                   <button class="action-btn view-details" title="View Details">üëÅÔ∏è</button>
                   <button class="action-btn edit-supplier" title="Edit">‚úèÔ∏è</button>
                   <button class="action-btn delete-supplier" title="Delete">üóëÔ∏è</button>
                 </td>
               </tr>`;
           }).join('');
           rows = Array.from(document.querySelectorAll('#suppliersTable tbody tr'));
           wireRowButtons();
           updateArchiveDisplay();
           applyFilters();
         } catch(_) { if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="color:#a3a3a3; padding:12px">Unable to load suppliers.</td></tr>'; }
       }

       // Initialize the page after DOM is ready
       document.addEventListener('DOMContentLoaded', () => {
         const select = document.getElementById('supplierCategory');
         const search = document.getElementById('supplierSearch');
         if (select) select.addEventListener('change', applyFilters);
         if (search) search.addEventListener('input', applyFilters);
         const addBtn = document.getElementById('addSupplierBtn');
         if (addBtn) addBtn.addEventListener('click', openAddSupplierModal);
         // Log Delivery launcher
         const logBtn = document.getElementById('logDeliveryBtn');
        if (logBtn) logBtn.addEventListener('click', async () => {
          await ensureProductCaches();
          const sel = document.getElementById('ldSupplier');
          if (sel) {
            sel.innerHTML = suppliers.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            sel.onchange = () => {
              document.querySelectorAll('#ldProductsBody .ldProductName').forEach(inp => {
                const ev = new Event('input');
                inp.dispatchEvent(ev);
              });
            };
          }
          const d = document.getElementById('ldDate');
          if (d) d.valueAsDate = new Date();

           // Initialize product rows and summary
           const tbody = document.getElementById('ldProductsBody');
           if (tbody) tbody.innerHTML = '';
           addProductRow();
           updateDeliverySummary();

           const addBtn = document.getElementById('ldAddProductBtn');
           if (addBtn) addBtn.onclick = () => { addProductRow(); };

           openModal('logDeliveryModal');
         });
         loadSuppliers();
       });
       
       // Global function to wire row buttons
       function wireRowButtons(){
         document.querySelectorAll('.view-details').forEach(btn => {
           btn.addEventListener('click', (e) => {
             const row = e.target.closest('tr');
             const supplierName = row.cells[0].textContent;
             openSupplierDetails(supplierName);
           });
         });
         document.querySelectorAll('.edit-supplier').forEach(btn => {
           btn.addEventListener('click', (e) => {
             const row = e.target.closest('tr');
             const supplierName = row.cells[0].textContent;
             openEditSupplierModal(supplierName);
           });
         });
         document.querySelectorAll('.delete-supplier').forEach(btn => {
           btn.addEventListener('click', (e) => {
             const row = e.target.closest('tr');
             const id = Number(row.getAttribute('data-id'));
             const supplierName = row.cells[0].textContent;
             deleteSupplier(id, supplierName);
           });
         });
         // Re-bind archive modal open button
         const openArchiveBtn = document.getElementById('openArchiveBtn');
         if (openArchiveBtn) openArchiveBtn.onclick = () => openModal('archiveModal');
        }

      // Stock movement localStorage helpers
      function getStockMovements() {
        try { return JSON.parse(localStorage.getItem('stockMovements') || '[]'); } catch { return []; }
      }
      function setStockMovements(list) {
        localStorage.setItem('stockMovements', JSON.stringify(list));
      }

      // Log Delivery save handler

      async function saveDelivery() {
        const supplier = (document.getElementById('ldSupplier')?.value || '').trim();
        const date = document.getElementById('ldDate')?.value;
        if (!supplier || !date) {
          alert('Please select supplier and date.');
          return;
        }

        const items = collectDeliveryRows();

        // Validate
        let valid = true;
        items.forEach(it => {
          it._nameEl?.style && (it._nameEl.style.outline = 'none');
          it._qtyEl?.style && (it._qtyEl.style.outline = 'none');
          if (!it.product || it.product.trim() === '') {
            valid = false; if (it._nameEl?.style) it._nameEl.style.outline = '2px solid #dc2626';
          }
          if (!it.qty || Number(it.qty) <= 0) {
            valid = false; if (it._qtyEl?.style) it._qtyEl.style.outline = '2px solid #dc2626';
          }
        });
        if (!items.length) { alert('Add at least one product.'); return; }
        if (!valid) { alert('Please fix errors: product name cannot be empty and quantity must be greater than 0.'); return; }

        const saveBtn = document.querySelector('#logDeliveryModal .btn.btn-primary');
        const originalText = saveBtn ? saveBtn.textContent : '';
        if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; }

        try {
          // Save each product to DB (sequential for reliability)
          for (const it of items) {
            const res = await fetch('api/stock_in.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify({ supplier, product: it.product.trim(), barcode: (it.barcode || '').trim(), category: it.category, qty: Number(it.qty), unitCost: Number(it.unitCost || 0), date })
            });
            const data = await res.json().catch(()=>({ ok:false, error:'Invalid server response' }));
            if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to save some items');
          }

          // Mirror to localStorage for reports/dashboard
          const entries = getStockMovements();
          items.forEach(it => {
            entries.push({ id: Date.now() + Math.random(), type: 'IN', date, supplier, product: it.product.trim(), category: it.category, qty: Number(it.qty), unitCost: Number(it.unitCost || 0) });
          });
          setStockMovements(entries);

          closeModal('logDeliveryModal');
          alert(`Delivery logged for ${items.length} product(s).`);
        } catch (e) {
          alert('Server error: ' + (e?.message || e));
        } finally {
          if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = originalText; }
        }
      }

      function addProductRow(prefill = {}) {
        const tbody = document.getElementById('ldProductsBody');
        if (!tbody) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:6px;">
            <input type="text" class="ldProductName" placeholder="Product name" value="${(prefill.product||'').replace(/\"/g,'&quot;')}" style="width:100%; padding:8px; border-radius:6px; border:1px solid #3a3a3a; background:#1a1a1a; color:#e5e5e5;" />
          </td>
          <td style="padding:6px;">
            <input type="text" class="ldBarcode" placeholder="Scan or enter barcode" value="${(prefill.barcode||'').replace(/\"/g,'&quot;')}" style="width:100%; padding:8px; border-radius:6px; border:1px solid #3a3a3a; background:#1a1a1a; color:#e5e5e5;" />
          </td>
          <td style="padding:6px;">
            <select class="ldCategory" style="width:100%; padding:8px; border-radius:6px; border:1px solid #3a3a3a; background:#1a1a1a; color:#e5e5e5;">
              <option value="Units">Units</option>
              <option value="Packs">Packs</option>
              <option value="Bottles">Bottles</option>
              <option value="Disposable">Disposable</option>
              <option value="E-juice">E-juice</option>
              <option value="Hardware">Hardware</option>
              <option value="Other">Other</option>
            </select>
          </td>
          <td style="padding:6px;">
            <input type="number" min="1" class="ldQty" value="${Number(prefill.qty||1)}" style="width:100%; padding:8px; border-radius:6px; border:1px solid #3a3a3a; background:#1a1a1a; color:#e5e5e5;" />
          </td>
          <td style="padding:6px;">
            <input type="number" min="0" step="0.01" class="ldUnitCost" value="${Number(prefill.unitCost||0)}" style="width:100%; padding:8px; border-radius:6px; border:1px solid #3a3a3a; background:#1a1a1a; color:#e5e5e5;" />
          </td>
          <td style="padding:6px; text-align:center;">
            <button type="button" class="btn btn-secondary ldRemoveRow">Remove</button>
          </td>
        `;
        tbody.appendChild(tr);
        // Set category if provided
        const catSel = tr.querySelector('.ldCategory');
        if (prefill.category) { catSel.value = prefill.category; }
        const nameEl = tr.querySelector('.ldProductName');
        const barcodeEl = tr.querySelector('.ldBarcode');
        const qtyEl = tr.querySelector('.ldQty');
        const costEl = tr.querySelector('.ldUnitCost');
        [nameEl, qtyEl, costEl, catSel, barcodeEl].forEach(el => el && el.addEventListener('input', updateDeliverySummary));
        // Attach autocomplete and barcode autofill
        attachNameAutocomplete(nameEl, barcodeEl, catSel, costEl);
        attachBarcodeAutoFill(barcodeEl, nameEl, catSel, costEl);
        const removeBtn = tr.querySelector('.ldRemoveRow');
        if (removeBtn) removeBtn.onclick = () => { tr.remove(); if (!document.querySelector('#ldProductsBody tr')) addProductRow(); updateDeliverySummary(); };
        updateDeliverySummary();
      }

      function collectDeliveryRows() {
        const rows = Array.from(document.querySelectorAll('#ldProductsBody tr'));
        return rows.map(tr => ({
          product: tr.querySelector('.ldProductName')?.value || '',
          barcode: tr.querySelector('.ldBarcode')?.value || '',
          category: tr.querySelector('.ldCategory')?.value || 'Units',
          qty: Number(tr.querySelector('.ldQty')?.value || 0),
          unitCost: Number(tr.querySelector('.ldUnitCost')?.value || 0),
          _nameEl: tr.querySelector('.ldProductName'),
          _barcodeEl: tr.querySelector('.ldBarcode'),
          _qtyEl: tr.querySelector('.ldQty'),
        }));
      }

      function updateDeliverySummary() {
        const items = collectDeliveryRows();
        let totalItems = 0; let totalCost = 0;
        items.forEach(it => { const q = Number(it.qty||0); const c = Number(it.unitCost||0); totalItems += isNaN(q)?0:q; totalCost += (isNaN(q)||isNaN(c))?0:(q*c); });
        const itemsEl = document.getElementById('ldTotalItems');
        const costEl = document.getElementById('ldTotalCost');
        if (itemsEl) itemsEl.textContent = String(totalItems);
        if (costEl) costEl.textContent = (Math.round(totalCost*100)/100).toFixed(2);
      }

       // Modal functions
       function openModal(modalId) {
         const el = document.getElementById(modalId);
         if (!el) return;
         el.style.display = 'flex';
         if (modalId === 'archiveModal') {
           updateArchiveDisplay();
         }
       }

       function closeModal(modalId) {
         const el = document.getElementById(modalId);
         if (!el) return;
         el.style.display = 'none';
       }

      function openAddSupplierModal() {
        currentSupplierId = null;
        document.getElementById('modalTitle').textContent = 'Add New Supplier';
        document.getElementById('supplierForm').reset();
        openModal('supplierModal');
      }

      function openEditSupplierModal(supplierName) {
        const supplier = suppliers.find(s => s.name === supplierName);
        if (!supplier) return;
        
        currentSupplierId = supplier.id;
        document.getElementById('modalTitle').textContent = 'Edit Supplier';
        
        // Populate form
        document.getElementById('supplierName').value = supplier.name;
        document.getElementById('supplierEmail').value = supplier.email;
        document.getElementById('supplierPhone').value = supplier.phone || '';
        document.getElementById('supplierAddress').value = supplier.address || '';
        document.getElementById('supplierNotes').value = supplier.notes || '';
        
        // Reset checkboxes
        document.querySelectorAll('.category-checkbox input').forEach(cb => {
          cb.checked = false;
        });
        
        // Check appropriate categories
        supplier.categories.forEach(cat => {
          const checkbox = document.querySelector(`.category-checkbox input[value="${cat}"]`);
          if (checkbox) checkbox.checked = true;
        });
        
        openModal('supplierModal');
      }

      function openSupplierDetails(supplierName) {
        const supplier = suppliers.find(s => s.name === supplierName);
        if (!supplier) return;
        
        // Populate details
        document.getElementById('detailSupplierName').value = supplier.name;
        document.getElementById('detailContact').value = supplier.email;
        
        // Update stats
        document.getElementById('totalProducts').textContent = supplier.totalProducts;
        document.getElementById('totalOrders').textContent = supplier.totalOrders;
        document.getElementById('totalSpent').textContent = `‚Ç±${supplier.totalSpent.toLocaleString()}`;
        document.getElementById('avgOrderValue').textContent = `‚Ç±${supplier.avgOrderValue}`;
        
        // Update categories
        const categoriesContainer = document.getElementById('detailCategories');
        categoriesContainer.innerHTML = supplier.categories.map(cat => 
          `<span class="category-tag">${cat}</span>`
        ).join('');
        
        openModal('supplierDetailsModal');
      }

      async function saveSupplier() {
        const form = document.getElementById('supplierForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        
        const selectedCategories = Array.from(document.querySelectorAll('.category-checkbox input:checked'))
          .map(cb => cb.value);
        
        if (selectedCategories.length === 0) {
          alert('Please select at least one category');
          return;
        }
        
        const supplierData = {
          name: document.getElementById('supplierName').value,
          email: document.getElementById('supplierEmail').value,
          phone: document.getElementById('supplierPhone').value,
          address: document.getElementById('supplierAddress').value,
          categories: selectedCategories,
          notes: document.getElementById('supplierNotes').value
        };
        
        try {
          if (currentSupplierId) {
            // Update existing supplier
            const response = await fetch('api/suppliers.php', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: currentSupplierId, ...supplierData })
            });
            const result = await response.json();
            if (!result.ok) throw new Error(result.error || 'Failed to update supplier');
          } else {
            // Add new supplier
            const response = await fetch('api/suppliers.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(supplierData)
            });
            const result = await response.json();
            if (!result.ok) throw new Error(result.error || 'Failed to add supplier');
          }
          
          closeModal('supplierModal');
          await loadSuppliers(); // Reload data from database
        } catch (error) {
          alert('Error: ' + error.message);
        }
      }

      async function deleteSupplier(id, supplierName) {
        if (confirm(`Are you sure you want to delete ${supplierName}?`)) {
          try {
            const response = await fetch(`api/suppliers.php?id=${id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: id, status: 'deleted' })
            });
            const result = await response.json();
            if (!result.ok) throw new Error(result.error || 'Failed to delete supplier');
            
            await loadSuppliers(); // Reload data from database
            alert(`${supplierName} has been moved to archive.`);
          } catch (error) {
            alert('Error: ' + error.message);
          }
        }
      }

      function editSupplier() {
        closeModal('supplierDetailsModal');
        const supplierName = document.getElementById('detailSupplierName').value;
        openEditSupplierModal(supplierName);
      }

      function openArchiveTab(status) {
        document.querySelectorAll('.archive-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.archive-content').forEach(content => {
          content.classList.remove('active');
        });

        document.querySelector(`.archive-tab[onclick="openArchiveTab('${status}')"]`).classList.add('active');
        document.getElementById(`${status}ArchiveContent`).classList.add('active');
        
        // Update the content for the active tab
        if (status === 'active') {
          updateActiveSuppliersDisplay();
        } else if (status === 'deleted') {
          updateArchiveDisplay();
        }
      }

      // (removed duplicate restore/permanent delete; single implementations below)

      // This function is no longer needed as we use the database
      // function addToArchive(supplier) {
      //   const archivedSupplier = {
      //     id: Date.now(),
      //     name: supplier.name,
      //     email: supplier.email,
      //     phone: supplier.phone || '',
      //     categories: supplier.categories,
      //     deletedDate: new Date().toLocaleDateString()
      //   };
      //   archivedSuppliers.push(archivedSupplier);
      //   updateArchiveDisplay();
      // }
      
      async function updateArchiveDisplay() {
        try {
          // Fetch deleted suppliers from database
          const response = await fetch('api/suppliers.php?status=deleted');
          const result = await response.json();
          const deletedSuppliers = result.ok ? result.data : [];
          
          // Update deleted suppliers display
          const deletedContent = document.getElementById('deletedArchiveContent');
          if (deletedSuppliers.length === 0) {
            deletedContent.innerHTML = '<p style="text-align: center; color: #a3a3a3; margin: 40px 0;">No deleted suppliers found.</p>';
          } else {
            let html = '';
            deletedSuppliers.forEach(supplier => {
              const categoryTags = Array.isArray(supplier.categories) 
                ? supplier.categories.map(cat => `<span class="category-tag">${cat}</span>`).join('')
                : '';
              html += `
                <div class="archive-item">
                  <div class="archive-item-header">
                    <div class="archive-item-name">${supplier.name}</div>
                    <div class="archive-item-date">Deleted: ${new Date(supplier.created_at).toLocaleDateString()}</div>
                  </div>
                  <div class="archive-item-email">${supplier.email || ''}</div>
                  <div class="archive-item-categories">${categoryTags}</div>
                  <div class="archive-item-actions">
                    <button class="restore-btn" onclick="restoreSupplier(${supplier.id})">Restore</button>
                    <button class="permanent-delete-btn" onclick="permanentDeleteSupplier(${supplier.id})">Delete Permanently</button>
                  </div>
                </div>
              `;
            });
            deletedContent.innerHTML = html;
          }
          
          // Update active suppliers display
          updateActiveSuppliersDisplay();
        } catch (error) {
          console.error('Error updating archive display:', error);
        }
      }
      
       function updateActiveSuppliersDisplay() {
        const activeContent = document.getElementById('activeSuppliersContent');
        const activeRows = document.querySelectorAll('#suppliersTable tbody tr');
        
        if (activeRows.length === 0) {
          activeContent.innerHTML = '<p style="text-align: center; color: #a3a3a3; margin: 40px 0;">No active suppliers found.</p>';
        } else {
          let html = '<table id="activeSuppliersTable"><thead><tr><th>Name</th><th>Email</th></tr></thead><tbody>';
          activeRows.forEach(row => {
            const name = row.cells[0].textContent.trim();
            const email = row.cells[1].textContent.trim();
            html += `
              <tr>
                <td>${name}</td>
                <td>${email}</td>
              </tr>
            `;
          });
          html += '</tbody></table>';
          activeContent.innerHTML = html;
        }
      }
      
       async function restoreSupplier(id) {
        if (confirm(`Are you sure you want to restore this supplier?`)) {
          try {
            const response = await fetch('api/suppliers.php', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: id, status: 'active' })
            });
            const result = await response.json();
            if (!result.ok) throw new Error(result.error || 'Failed to restore supplier');
            
            await loadSuppliers(); // Reload data from database
            await updateArchiveDisplay(); // Update archive display
            alert('Supplier has been restored successfully!');
          } catch (error) {
            alert('Error: ' + error.message);
          }
        }
      }
      
       async function permanentDeleteSupplier(id) {
        if (confirm(`Are you sure you want to permanently delete this supplier? This action cannot be undone.`)) {
          try {
            const response = await fetch(`api/suppliers.php?id=${id}`, { method: 'DELETE' });
            const result = await response.json();
            if (!result.ok) throw new Error(result.error || 'Failed to permanently delete supplier');
            
            await updateArchiveDisplay(); // Update archive display
            alert('Supplier has been permanently deleted!');
          } catch (error) {
            alert('Error: ' + error.message);
          }
        }
      }
      
      async function emptyArchive() {
        if (confirm(`Are you sure you want to empty the archive? This action cannot be undone.`)) {
          try {
            // Get all deleted suppliers and permanently delete them
            const response = await fetch('api/suppliers.php?status=deleted');
            const result = await response.json();
            const deletedSuppliers = result.ok ? result.data : [];
            
            for (const supplier of deletedSuppliers) {
              await fetch(`api/suppliers.php?id=${supplier.id}`, { method: 'DELETE' });
            }
            
            await updateArchiveDisplay();
            alert('Archive has been emptied successfully!');
          } catch (error) {
            alert('Error: ' + error.message);
          }
        }
      }
    </script>
    <script src="global.js"></script>
  </body>
</html>
